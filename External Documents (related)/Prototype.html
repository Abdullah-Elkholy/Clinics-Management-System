<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة العيادات الطبية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Tajawal', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', Arial, sans-serif; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .dragging { opacity: 0.5; }
        .drop-zone { border: 2px dashed #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50 font-arabic">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-clinic-medical text-blue-600 text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">نظام إدارة العيادات</h1>
                <p class="text-gray-600">تسجيل الدخول إلى النظام</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم المستخدم</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل اسم المستخدم" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="أدخل كلمة المرور" required onkeypress="if(event.key==='Enter') handleLogin()">
                </div>
                
                <button type="button" onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    تسجيل الدخول
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">للتجربة، استخدم:</p>
                <div class="mt-2 space-y-1 text-xs">
                    <p><strong>مدير أساسي:</strong> admin / admin123</p>
                    <p><strong>مدير ثانوي:</strong> admin2 / admin123</p>
                    <p><strong>مشرف:</strong> mod1 / mod123</p>
                    <p><strong>مستخدم:</strong> user1 / user123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-40">
            <div class="flex items-center justify-between px-6 py-4">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="fas fa-clinic-medical text-blue-600"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">نظام إدارة العيادات</h1>
                        <p class="text-sm text-gray-600" id="userRole">مدير أساسي</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div id="whatsappStatus" class="hidden flex items-center space-x-2 space-x-reverse bg-green-100 px-3 py-1 rounded-full">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-green-700">واتساب متصل</span>
                    </div>
                    
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <span class="text-sm text-gray-700" id="currentUser">المدير الأساسي</span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-700">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex h-screen pt-16">
            <!-- Left Panel (Navigation) -->
            <div class="w-1/4 bg-white shadow-lg border-l border-gray-200">
                <nav class="p-4">
                    <ul class="space-y-2">
                        <li>
                            <button onclick="showMessages()" class="nav-item w-full text-right px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200 flex items-center justify-between">
                                <span>الرسائل</span>
                                <i class="fas fa-comments"></i>
                            </button>
                        </li>
                        <li>
                            <button onclick="showManagement()" class="nav-item w-full text-right px-4 py-3 rounded-lg hover:bg-blue-50 hover:text-blue-600 transition duration-200 flex items-center justify-between">
                                <span>الإدارة</span>
                                <i class="fas fa-cog"></i>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- Queues Panel -->
                <div id="queuesPanel" class="p-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-800">الطوابير</h3>
                        <button id="addQueueBtn" onclick="showAddQueueModal()" class="hidden bg-blue-600 text-white w-8 h-8 rounded-full hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                    
                    <div id="queuesList" class="space-y-2">
                        <!-- Queues will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Right Panel (Content) -->
            <div class="flex-1 bg-white">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="p-8 text-center">
                    <div class="max-w-md mx-auto">
                        <div class="bg-blue-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-clinic-medical text-blue-600 text-4xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">مرحباً بك في نظام إدارة العيادات</h2>
                        <p class="text-gray-600 mb-6">اختر من القائمة الجانبية للبدء في إدارة الطوابير والرسائل</p>
                    </div>
                </div>

                <!-- Queue Details Panel -->
                <div id="queueDetailsPanel" class="hidden">
                    <!-- Sub-navigation tabs -->
                    <div class="border-b border-gray-200 bg-gray-50">
                        <nav class="flex space-x-8 space-x-reverse px-6">
                            <button onclick="showTab('dashboard')" class="tab-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600 transition duration-200 font-medium">
                                لوحة التحكم الرئيسية
                            </button>
                            <button onclick="showTab('ongoing')" class="tab-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600 transition duration-200 font-medium">
                                المهام الجارية
                            </button>
                            <button onclick="showTab('failed')" class="tab-btn py-4 px-2 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600 transition duration-200 font-medium">
                                المهام الفاشلة
                            </button>
                        </nav>
                    </div>

                    <!-- Dashboard Tab -->
                    <div id="dashboardTab" class="p-6">
                        <!-- Queue Header -->
                        <div class="bg-gradient-to-l from-blue-600 to-purple-600 text-white p-6 rounded-xl mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 id="doctorName" class="text-2xl font-bold mb-2">د. أحمد محمد</h2>
                                    <div class="grid grid-cols-3 gap-4 text-blue-100">
                                        <div>
                                            <p class="text-sm">عدد المرضى</p>
                                            <p id="patientCount" class="text-xl font-bold">15</p>
                                        </div>
                                        <div>
                                            <p class="text-sm">الموضع الحالي (CQP)</p>
                                            <input type="number" id="currentPosition" class="text-xl font-bold bg-transparent border-b border-blue-300 text-white w-16 text-center" value="3" onchange="updateQueueMetrics()">
                                        </div>
                                        <div>
                                            <p class="text-sm">الوقت المقدر للجلسة (ETS)</p>
                                            <div class="flex items-center">
                                                <input type="number" id="estimatedTime" class="text-xl font-bold bg-transparent border-b border-blue-300 text-white w-16 text-center" value="15" onchange="updateQueueMetrics()">
                                                <span class="text-xl font-bold mr-1">دقيقة</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-left">
                                    <div class="bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                                        <i class="fas fa-users text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <button onclick="showAddPatientModal()" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-user-plus"></i>
                                <span>إضافة مريض يدوياً</span>
                            </button>
                            
                            <button onclick="showUploadModal()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-upload"></i>
                                <span>رفع ملف المرضى</span>
                            </button>
                            
                            <button onclick="deleteSelectedPatients()" class="bg-red-600 text-white p-4 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-trash"></i>
                                <span id="deleteSelectedText">حذف المحدد</span>
                            </button>
                            
                            <button onclick="sendToSelectedPatients()" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fab fa-whatsapp"></i>
                                <span id="sendSelectedText">إرسال للمحدد</span>
                            </button>
                        </div>

                        <!-- Message Selection -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700">الرسالة الافتراضية المحددة</label>
                                <button onclick="showMessageSelectionModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">
                                    <i class="fas fa-edit ml-1"></i>
                                    تغيير الرسالة
                                </button>
                            </div>
                            <div class="bg-white p-3 rounded border border-gray-200">
                                <p id="selectedMessageText" class="text-gray-800">مرحباً، موعدك اليوم في العيادة</p>
                                <div id="messageConditions" class="mt-2 text-sm text-gray-600">
                                    <p><strong>الشروط:</strong> إرسال قبل الموعد بساعة واحدة</p>
                                </div>
                            </div>
                        </div>

                        <!-- Patients Table -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-bold text-gray-800">قائمة المرضى</h3>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded">
                                        <label for="selectAll" class="text-sm text-gray-600">تحديد الكل</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">تحديد</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">سحب</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الترتيب</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الاسم الكامل</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">رقم الهاتف</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patientsTable" class="divide-y divide-gray-200">
                                        <!-- Patients will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Ongoing Tasks Tab -->
                    <div id="ongoingTab" class="hidden p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">المهام الجارية</h3>
                            <button onclick="pauseAllTasks()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
                                <i class="fas fa-pause ml-1"></i>
                                إيقاف مؤقت للكل
                            </button>
                        </div>
                        
                        <!-- Progress Indicator -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-blue-800">تقدم الإرسال</h4>
                                <span class="text-sm text-blue-600" id="progressText">تم معالجة 15 من 50 رسالة, منهم 4 محاولات فاشلة</span>
                            </div>
                            <div class="bg-blue-200 rounded-full h-3">
                                <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 30%" id="progressBar"></div>
                            </div>
                        </div>
                        
                        <div class="space-y-6" id="ongoingTasks">
                            <!-- Ongoing tasks will be populated here -->
                        </div>
                    </div>

                    <!-- Failed Tasks Tab -->
                    <div id="failedTab" class="hidden p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">المهام الفاشلة</h3>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="deleteSelectedFailedTasks()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-trash ml-1"></i>
                                    <span id="deleteFailedText">حذف 0 مريض محدد</span>
                                </button>
                                <button onclick="showRetryPreview()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
                                    <i class="fas fa-redo ml-1"></i>
                                    إعادة محاولة المحدد
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-red-50">
                                        <tr>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-red-700 uppercase">تحديد</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-red-700 uppercase">اسم المريض</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-red-700 uppercase">رقم الهاتف</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-red-700 uppercase">سبب الفشل</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-red-700 uppercase">وقت المحاولة</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-red-700 uppercase">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="failedTasksTable" class="divide-y divide-gray-200">
                                        <!-- Failed tasks will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Panel -->
                <div id="messagesPanel" class="hidden p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">إدارة الرسائل</h2>
                    
                    <div id="messagesContent">
                        <!-- Content will be populated based on user role -->
                    </div>
                </div>

                <!-- Management Panel -->
                <div id="managementPanel" class="hidden p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">إدارة النظام</h2>
                    
                    <div id="managementContent">
                        <!-- Content will be populated based on user role -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Queue Modal -->
    <div id="addQueueModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة طابور جديد</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم الطبيب</label>
                    <input type="text" id="newDoctorName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل اسم الطبيب">
                </div>
                <div class="flex space-x-3 space-x-reverse">
                    <button onclick="addQueue()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                        إضافة
                    </button>
                    <button onclick="closeModal('addQueueModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div id="addPatientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-96 overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة مرضى جدد</h3>
            <div id="patientSlots">
                <div class="patient-slot border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-3">
                        <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab ml-3" draggable="true">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <span class="text-sm text-gray-600">اسحب لإعادة الترتيب</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الكامل</label>
                            <input type="text" class="name-input w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الكامل">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
                            <div class="flex">
                                <select class="country-code px-2 py-2 border border-gray-300 rounded-r-lg bg-gray-50">
                                    <option value="+20">+20 (مصر)</option>
                                    <option value="+966">+966 (السعودية)</option>
                                    <option value="+971">+971 (الإمارات)</option>
                                </select>
                                <input type="tel" class="phone-input flex-1 px-3 py-2 border border-gray-300 rounded-l-lg" placeholder="رقم الهاتف">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between mb-4">
                <button onclick="addPatientSlot()" class="text-blue-600 hover:text-blue-700">
                    <i class="fas fa-plus ml-1"></i>
                    إضافة مريض آخر
                </button>
                <span class="text-sm text-gray-600">الحد الأقصى: 50 مريض</span>
            </div>
            
            <div class="flex space-x-3 space-x-reverse">
                <button onclick="addPatients()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    إضافة المرضى
                </button>
                <button onclick="closeModal('addPatientModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">رفع ملف المرضى</h3>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-4">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">اسحب الملف هنا أو انقر للاختيار</p>
                <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(event)">
                <button onclick="document.getElementById('excelFile').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    اختيار ملف Excel
                </button>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-yellow-800 mb-2">نموذج الملف المطلوب:</h4>
                <div class="text-sm text-yellow-700">
                    <p>العمود الأول: الترتيب</p>
                    <p>العمود الثاني: الاسم الكامل</p>
                    <p>العمود الثالث: رقم الهاتف</p>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse">
                <button onclick="processUpload()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    رفع ومعالجة
                </button>
                <button onclick="closeModal('uploadModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Message Selection Modal -->
    <div id="messageSelectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">اختيار الرسالة الافتراضية</h3>
                <button onclick="closeModal('messageSelectionModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div id="messageTemplatesList">
                    <!-- Message templates will be populated here -->
                </div>
            </div>
            
            <div class="border-t pt-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-800">الشروط الاختيارية (حتى 5 شروط)</h4>
                    <button onclick="addCondition()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                        <i class="fas fa-plus ml-1"></i>
                        إضافة شرط
                    </button>
                </div>
                
                <div id="conditionsList" class="space-y-3">
                    <!-- Conditions will be populated here -->
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-4">
                    <h5 class="font-medium text-yellow-800 mb-2">أمثلة على الشروط:</h5>
                    <div class="text-sm text-yellow-700 space-y-1">
                        <p>• نطاق: المرضى من الترتيب 2 إلى 5 يحصلون على رسالة مختلفة</p>
                        <p>• أقل من: المرضى في الترتيب أقل من 3 يحصلون على رسالة مختلفة</p>
                        <p>• أكثر من: المرضى في الترتيب أكثر من 10 يحصلون على رسالة مختلفة</p>
                        <p class="font-medium">الباقي يحصلون على الرسالة الافتراضية المحددة أعلاه</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="applyMessageSelection()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    تطبيق الاختيار
                </button>
                <button onclick="closeModal('messageSelectionModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Message Preview Modal -->
    <div id="messagePreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">معاينة الرسائل قبل الإرسال</h3>
                <button onclick="closeModal('messagePreviewModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-medium text-blue-800">الرسالة المحددة</h4>
                        <p class="text-sm text-blue-600" id="previewMessageTemplate">مرحباً، موعدك اليوم في العيادة</p>
                    </div>
                    <div class="text-blue-600">
                        <span id="previewPatientCount" class="text-2xl font-bold">0</span>
                        <p class="text-sm">مريض محدد</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h4 class="font-bold text-gray-800">جدول المعاينة</h4>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الترتيب</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">اسم المريض</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">رقم الهاتف</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase preview-message-column">
                                    <div class="flex items-center justify-between">
                                        <span>الرسالة المخصصة</span>
                                        <button onclick="togglePreviewMessages()" class="text-blue-600 hover:text-blue-700 text-xs">
                                            <span id="togglePreviewText">إخفاء</span>
                                        </button>
                                    </div>
                                </th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحالة المتوقعة</th>
                            </tr>
                        </thead>
                        <tbody id="previewTable" class="divide-y divide-gray-200">
                            <!-- Preview data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="confirmSendMessages()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    <i class="fab fa-whatsapp ml-2"></i>
                    تأكيد الإرسال
                </button>
                <button onclick="closeModal('messagePreviewModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Add Message Template Modal -->
    <div id="addMessageTemplateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">إضافة قالب رسالة جديد</h3>
                <button onclick="closeModal('addMessageTemplateModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">عنوان القالب</label>
                    <input type="text" id="newMessageTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل عنوان القالب">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">محتوى الرسالة</label>
                    <textarea id="newMessageContent" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل محتوى الرسالة"></textarea>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h4 class="font-medium text-blue-800 mb-2">المتغيرات المتاحة (انقر لإضافة):</h4>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><button type="button" onclick="insertVariable('{CQP}')" class="bg-blue-200 hover:bg-blue-300 px-2 py-1 rounded text-blue-800 font-mono">{CQP}</button> - الموضع الحالي للطابور (Current Queue Position)</p>
                        <p><button type="button" onclick="insertVariable('{PQP}')" class="bg-blue-200 hover:bg-blue-300 px-2 py-1 rounded text-blue-800 font-mono">{PQP}</button> - موضع المريض في الطابور (Patient Queue Position)</p>
                        <p><button type="button" onclick="insertVariable('{ETS}')" class="bg-blue-200 hover:bg-blue-300 px-2 py-1 rounded text-blue-800 font-mono">{ETS}</button> - الوقت المقدر للجلسة (Estimated Time per Session)</p>
                        <p><button type="button" onclick="insertVariable('{ETR}')" class="bg-blue-200 hover:bg-blue-300 px-2 py-1 rounded text-blue-800 font-mono">{ETR}</button> - الوقت المتبقي المقدر (Estimated Time Remaining)</p>
                        <p><button type="button" onclick="insertVariable('{PN}')" class="bg-blue-200 hover:bg-blue-300 px-2 py-1 rounded text-blue-800 font-mono">{PN}</button> - اسم المريض (Patient Name)</p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="addMessageTemplate()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    إضافة القالب
                </button>
                <button onclick="closeModal('addMessageTemplateModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Account Info Modal -->
    <div id="accountInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-4">تعديل معلومات الحساب</h3>
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأول</label>
                        <input type="text" id="editFirstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الأول">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأخير</label>
                        <input type="text" id="editLastName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الأخير">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم المستخدم (معرف تسجيل الدخول)</label>
                    <input type="text" id="editUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل اسم المستخدم">
                </div>
                
                <!-- Password Change Section -->
                <div class="border-t pt-4">
                    <button type="button" onclick="togglePasswordChange()" class="flex items-center justify-between w-full text-left text-sm font-medium text-gray-700 hover:text-gray-900">
                        <span>تغيير كلمة المرور</span>
                        <div class="flex items-center">
                            <span id="passwordToggleText" class="ml-2">إظهار</span>
                            <i id="passwordToggleIcon" class="fas fa-chevron-down"></i>
                        </div>
                    </button>
                    
                    <div id="passwordChangeSection" class="hidden mt-3 space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور الحالية</label>
                            <input type="password" id="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل كلمة المرور الحالية">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور الجديدة</label>
                            <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل كلمة المرور الجديدة">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">إعادة كتابة كلمة المرور الجديدة</label>
                            <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أعد كتابة كلمة المرور الجديدة">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="saveAccountInfo()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    حفظ التغييرات
                </button>
                <button onclick="closeModal('accountInfoModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Authentication Modal -->
    <div id="whatsappAuthModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">مصادقة جلسة واتساب</h3>
            
            <div class="text-center mb-6">
                <div class="bg-gray-100 w-48 h-48 mx-auto rounded-lg flex items-center justify-center mb-4">
                    <div class="text-center">
                        <i class="fas fa-qrcode text-6xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-600">رمز QR للمسح</p>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle ml-1"></i>
                        افتح واتساب على هاتفك واذهب إلى الإعدادات > الأجهزة المرتبطة > ربط جهاز
                    </p>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse">
                <button onclick="authenticateWhatsApp()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    <i class="fab fa-whatsapp ml-1"></i>
                    تأكيد المصادقة
                </button>
                <button onclick="closeModal('whatsappAuthModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Queue Modal -->
    <div id="editQueueModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">تعديل الطابور</h3>
                <button onclick="closeModal('editQueueModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم الطبيب</label>
                    <input type="text" id="editDoctorName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل اسم الطبيب">
                </div>
                <div class="flex space-x-3 space-x-reverse">
                    <button onclick="saveQueueEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                        حفظ التغييرات
                    </button>
                    <button onclick="closeModal('editQueueModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">تعديل بيانات المستخدم</h3>
                <button onclick="closeModal('editUserModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأول</label>
                        <input type="text" id="editUserFirstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الأول">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الأخير</label>
                        <input type="text" id="editUserLastName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الأخير">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">اسم المستخدم</label>
                        <input type="text" id="editUserUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل اسم المستخدم">
                    </div>
                </div>
                
                <div id="editUserModeratorSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">المشرف</label>
                    <select id="editUserModerator" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                

                
                <!-- Password Reset Section -->
                <div class="border-t pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-medium text-gray-800">إعادة تعيين كلمة المرور</h4>
                        <button type="button" onclick="resetEditUserPassword()" class="bg-yellow-600 text-white px-3 py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
                            <i class="fas fa-key ml-1"></i>
                            إعادة تعيين
                        </button>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-700">
                            <i class="fas fa-info-circle ml-1"></i>
                            سيتم إنشاء كلمة مرور جديدة تلقائياً وعرضها لك
                        </p>
                    </div>
                    <div id="newPasswordDisplay" class="hidden mt-3 bg-green-50 border border-green-200 rounded-lg p-3">
                        <p class="text-sm text-green-700 font-medium">كلمة المرور الجديدة:</p>
                        <p class="text-lg font-mono bg-white px-3 py-2 rounded border mt-2" id="generatedPassword"></p>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="saveUserEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    حفظ التغييرات
                </button>
                <button onclick="closeModal('editUserModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Retry Preview Modal -->
    <div id="retryPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">معاينة إعادة المحاولة</h3>
                <button onclick="closeModal('retryPreviewModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-medium text-yellow-800">المهام الفاشلة المحددة لإعادة المحاولة</h4>
                        <p class="text-sm text-yellow-600" id="retryPreviewCount">0 مهمة محددة</p>
                    </div>
                    <div class="text-yellow-600">
                        <i class="fas fa-redo text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h4 class="font-bold text-gray-800">جدول المعاينة</h4>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">اسم المريض</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">رقم الهاتف</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">سبب الفشل السابق</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحالة المتوقعة</th>
                            </tr>
                        </thead>
                        <tbody id="retryPreviewTable" class="divide-y divide-gray-200">
                            <!-- Retry preview data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="confirmRetryTasks()" class="flex-1 bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
                    <i class="fas fa-redo ml-2"></i>
                    تأكيد إعادة المحاولة
                </button>
                <button onclick="closeModal('retryPreviewModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Quota Management Modal -->
    <div id="quotaManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">إدارة حصة المشرف</h3>
                <button onclick="closeModal('quotaManagementModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Moderator Info -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-800 mb-2" id="quotaModeratorName">محمد أحمد</h4>
                    <p class="text-sm text-blue-600" id="quotaModeratorUsername">mod1</p>
                </div>
                
                <!-- Messages Quota Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-800 mb-3">حصة الرسائل</h4>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalMessagesQuotaDisplay">100</div>
                            <div class="text-sm text-blue-700">الحصة الإجمالية</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="consumedMessagesQuotaDisplay">45</div>
                            <div class="text-sm text-orange-700">الحصة المستهلكة</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-600" id="remainingMessagesQuotaDisplay">55</div>
                            <div class="text-sm text-green-700">الحصة المتبقية</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <input type="number" id="addMessagesQuota" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الكمية المراد إضافتها" min="0">
                        <button onclick="addQuota('messages')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة
                        </button>
                    </div>
                </div>
                
                <!-- Queues Quota Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-800 mb-3">حصة الطوابير</h4>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalQueuesQuotaDisplay">5</div>
                            <div class="text-sm text-blue-700">الحصة الإجمالية</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="consumedQueuesQuotaDisplay">3</div>
                            <div class="text-sm text-orange-700">الحصة المستهلكة</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-600" id="remainingQueuesQuotaDisplay">2</div>
                            <div class="text-sm text-green-700">الحصة المتبقية</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <input type="number" id="addQueuesQuota" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الكمية المراد إضافتها" min="0">
                        <button onclick="addQuota('queues')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-plus ml-1"></i>
                            إضافة
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="closeModal('quotaManagementModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Patient Modal -->
    <div id="editPatientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">تعديل بيانات المريض</h3>
                <button onclick="closeModal('editPatientModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الكامل</label>
                    <input type="text" id="editPatientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الكامل">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
                    <input type="tel" id="editPatientPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل رقم الهاتف">
                </div>
            </div>
            
            <div class="flex space-x-3 space-x-reverse mt-6">
                <button onclick="savePatientEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    حفظ التغييرات
                </button>
                <button onclick="closeModal('editPatientModal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 left-4 z-50 space-y-2"></div>

    <script>
        // Global state
        let currentUser = null;
        let currentQueue = null;
        let patients = [];
        let failedTasks = [];
        let selectedMessageTemplate = { id: 1, title: 'رسالة الموعد', content: 'مرحباً، موعدك اليوم في العيادة' };
        let messageConditions = [];
        let queues = [
            { id: 1, doctorName: 'د. أحمد محمد', patientCount: 15, createdBy: 'admin', currentPosition: 3, estimatedTime: 15 },
            { id: 2, doctorName: 'د. فاطمة علي', patientCount: 8, createdBy: 'mod1', currentPosition: 2, estimatedTime: 20 },
            { id: 3, doctorName: 'د. محمد حسن', patientCount: 12, createdBy: 'admin', currentPosition: 5, estimatedTime: 12 }
        ];
        let messageTemplates = [
            { id: 1, title: 'رسالة الموعد', content: 'مرحباً {PN}، ترتيبك {PQP} والموضع الحالي {CQP}، الوقت المتبقي المقدر {ETR} دقيقة', createdBy: 'admin', moderator: null },
            { id: 2, title: 'تذكير', content: 'تذكير بموعدك {PN}، ترتيبك {PQP} والوقت المتبقي {ETR} دقيقة', createdBy: 'mod1', moderator: 'محمد أحمد' },
            { id: 3, title: 'تأجيل', content: 'تم تأجيل موعدك {PN}', createdBy: 'admin', moderator: null },
            { id: 4, title: 'وصول الدور', content: 'حان دورك الآن {PN}، الموضع الحالي {CQP}', createdBy: 'mod2', moderator: 'سارة علي' }
        ];

        // User roles and permissions
        const users = {
            'admin': { role: 'primary_admin', name: 'المدير الأساسي', password: 'admin123' },
            'admin2': { role: 'secondary_admin', name: 'المدير الثانوي', password: 'admin123' },
            'mod1': { role: 'moderator', name: 'المشرف الأول', password: 'mod123' },
            'user1': { role: 'user', name: 'المستخدم الأول', password: 'user123' }
        };

        // Login functionality
        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showToast('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                return;
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                showMainApp();
            } else {
                showToast('خطأ في اسم المستخدم أو كلمة المرور', 'error');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update UI based on user role
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
            
            // Show/hide elements based on role
            updateUIForRole();
            
            // Initialize data
            populateQueues();
            
            showToast(`مرحباً ${currentUser.name}`, 'success');
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'primary_admin': 'مدير أساسي',
                'secondary_admin': 'مدير ثانوي',
                'moderator': 'مشرف',
                'user': 'مستخدم'
            };
            return roleNames[role] || role;
        }

        function updateUIForRole() {
            const role = currentUser.role;
            
            // Show WhatsApp status for users and moderators (shared session per moderator)
            if (role === 'user' || role === 'moderator') {
                document.getElementById('whatsappStatus').classList.remove('hidden');
                // For users, show their moderator's WhatsApp session status
                if (role === 'user') {
                    const userModerator = getUserModerator(currentUser.username);
                    if (userModerator) {
                        updateWhatsAppStatusDisplay(userModerator.whatsappStatus);
                    }
                }
            } else {
                // Hide WhatsApp status for admins
                document.getElementById('whatsappStatus').classList.add('hidden');
            }
            
            // Show add queue button for moderators and users
            if (role === 'moderator' || role === 'user') {
                document.getElementById('addQueueBtn').classList.remove('hidden');
            }
        }

        function getUserModerator(username) {
            // Find which moderator manages this user
            const userRecord = managedUsers.user.find(u => u.username === username);
            if (userRecord) {
                return managedUsers.moderator.find(m => m.fullName === userRecord.moderator);
            }
            return null;
        }

        function updateWhatsAppStatusDisplay(status) {
            const statusElement = document.getElementById('whatsappStatus');
            const statusText = statusElement.querySelector('span');
            const statusDot = statusElement.querySelector('div');
            
            if (status === 'متصل') {
                statusElement.className = 'flex items-center space-x-2 space-x-reverse bg-green-100 px-3 py-1 rounded-full';
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                statusText.className = 'text-sm text-green-700';
                statusText.textContent = 'واتساب متصل';
            } else {
                statusElement.className = 'flex items-center space-x-2 space-x-reverse bg-red-100 px-3 py-1 rounded-full';
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
                statusText.className = 'text-sm text-red-700';
                statusText.textContent = 'واتساب غير متصل';
            }
        }

        function logout() {
            currentUser = null;
            currentQueue = null;
            patients = [];
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideAllPanels();
            document.getElementById('welcomeScreen').classList.remove('hidden');
        }

        // Navigation functions
        function showMessages() {
            hideAllPanels();
            document.getElementById('messagesPanel').classList.remove('hidden');
            populateMessagesContent();
            setActiveNavItem(0);
        }

        function showManagement() {
            hideAllPanels();
            document.getElementById('managementPanel').classList.remove('hidden');
            populateManagementContent();
            setActiveNavItem(1);
        }

        function hideAllPanels() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('queueDetailsPanel').classList.add('hidden');
            document.getElementById('messagesPanel').classList.add('hidden');
            document.getElementById('managementPanel').classList.add('hidden');
        }

        function setActiveNavItem(index) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('bg-blue-50', 'text-blue-600');
                } else {
                    item.classList.remove('bg-blue-50', 'text-blue-600');
                }
            });
        }

        // Queue management
        function populateQueues() {
            const queuesList = document.getElementById('queuesList');
            queuesList.innerHTML = '';
            
            if (currentUser.role === 'primary_admin' || currentUser.role === 'secondary_admin') {
                // For admins, show moderators with their queues
                const moderators = managedUsers.moderator || [];
                
                moderators.forEach(moderator => {
                    const moderatorQueues = queues.filter(q => q.createdBy === moderator.username);
                    
                    const moderatorElement = document.createElement('div');
                    moderatorElement.className = 'mb-4';
                    
                    moderatorElement.innerHTML = `
                        <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div>
                                <h4 class="font-medium text-blue-800">${moderator.fullName}</h4>
                                <p class="text-sm text-blue-600">${moderatorQueues.length} طابور</p>
                            </div>
                            <button onclick="toggleModeratorQueues('${moderator.id}')" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-chevron-down" id="chevron-mod-${moderator.id}"></i>
                            </button>
                        </div>
                        <div id="queues-mod-${moderator.id}" class="hidden mt-2 mr-4 space-y-2">
                            ${moderatorQueues.map(queue => `
                                <div class="queue-item p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200" onclick="showQueueDetails(${JSON.stringify(queue).replace(/"/g, '&quot;')})">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h5 class="font-medium text-gray-800">${queue.doctorName}</h5>
                                            <p class="text-sm text-gray-600">المرضى: ${queue.patientCount}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${moderatorQueues.length === 0 ? '<p class="text-gray-500 text-sm p-3">لا توجد طوابير</p>' : ''}
                        </div>
                    `;
                    
                    queuesList.appendChild(moderatorElement);
                });
            } else {
                // For moderators and users, show queues normally
                queues.forEach(queue => {
                    // Filter queues based on user role
                    if (currentUser.role === 'moderator' && queue.createdBy !== currentUser.username) {
                        return; // Skip queues not created by this moderator
                    }
                    if (currentUser.role === 'user') {
                        // Users can see queues from their moderator
                        const userRecord = managedUsers.user.find(u => u.username === currentUser.username);
                        const userModerator = managedUsers.moderator.find(m => m.fullName === userRecord?.moderator);
                        if (queue.createdBy !== userModerator?.username) {
                            return;
                        }
                    }
                    
                    const queueElement = document.createElement('div');
                    queueElement.className = 'queue-item p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition duration-200';
                    queueElement.onclick = () => showQueueDetails(queue);
                    
                    queueElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">${queue.doctorName}</h4>
                                <p class="text-sm text-gray-600">المرضى: ${queue.patientCount}</p>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                ${currentUser.role === 'moderator' ? `
                                    <button onclick="editQueue(${queue.id}); event.stopPropagation();" class="text-blue-600 hover:text-blue-700">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteQueue(${queue.id}); event.stopPropagation();" class="text-red-600 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    queuesList.appendChild(queueElement);
                });
            }
        }

        function toggleModeratorQueues(moderatorId) {
            const queuesDiv = document.getElementById(`queues-mod-${moderatorId}`);
            const chevron = document.getElementById(`chevron-mod-${moderatorId}`);
            
            if (queuesDiv.classList.contains('hidden')) {
                queuesDiv.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                queuesDiv.classList.add('hidden');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }

        function showQueueDetails(queue) {
            currentQueue = queue;
            hideAllPanels();
            document.getElementById('queueDetailsPanel').classList.remove('hidden');
            
            // Update queue header
            document.getElementById('doctorName').textContent = queue.doctorName;
            document.getElementById('patientCount').textContent = queue.patientCount;
            document.getElementById('currentPosition').value = queue.currentPosition;
            document.getElementById('estimatedTime').value = queue.estimatedTime;
            
            // Show dashboard tab by default
            showTab('dashboard');
            
            // Generate sample patients for demo
            generateSamplePatients();
        }

        function generateSamplePatients() {
            patients = [];
            const sampleNames = ['أحمد محمد', 'فاطمة علي', 'محمد حسن', 'عائشة أحمد', 'علي محمود'];
            
            for (let i = 0; i < currentQueue.patientCount; i++) {
                patients.push({
                    id: i + 1,
                    position: i + 1,
                    name: sampleNames[i % sampleNames.length],
                    phone: `+20100000${String(i + 1).padStart(4, '0')}`,
                    status: Math.random() > 0.8 ? 'فشل' : 'في الانتظار'
                });
            }
            
            populatePatientsTable();
        }

        function populatePatientsTable() {
            const tbody = document.getElementById('patientsTable');
            tbody.innerHTML = '';
            
            patients.forEach(patient => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = patient.status === 'فشل' ? 'bg-red-100 text-red-800' : 
                                   patient.status === 'تم الإرسال' ? 'bg-green-100 text-green-800' : 
                                   'bg-yellow-100 text-yellow-800';
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" class="patient-checkbox rounded" value="${patient.id}" onchange="updateSelectedCount()">
                    </td>
                    <td class="px-6 py-4">
                        <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab" draggable="true">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">${patient.position}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${patient.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${patient.phone}</td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="sendMessage(${patient.id})" class="text-green-600 hover:text-green-700" title="إرسال واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button onclick="editPatient(${patient.id})" class="text-blue-600 hover:text-blue-700" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletePatient(${patient.id})" class="text-red-600 hover:text-red-700" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Add drag and drop event listeners
                const dragHandle = row.querySelector('.drag-handle');
                dragHandle.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', patient.id);
                    row.classList.add('dragging');
                });
                
                dragHandle.addEventListener('dragend', () => {
                    row.classList.remove('dragging');
                });
                
                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    row.classList.add('drop-zone');
                });
                
                row.addEventListener('dragleave', () => {
                    row.classList.remove('drop-zone');
                });
                
                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    row.classList.remove('drop-zone');
                    const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetId = patient.id;
                    
                    if (draggedId !== targetId) {
                        reorderPatients(draggedId, targetId);
                    }
                });
                
                tbody.appendChild(row);
            });
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('dashboardTab').classList.add('hidden');
            document.getElementById('ongoingTab').classList.add('hidden');
            document.getElementById('failedTab').classList.add('hidden');
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
            });
            event.target.classList.add('border-blue-500', 'text-blue-600');
            
            // Populate tab content
            if (tabName === 'ongoing') {
                populateOngoingTasks();
            } else if (tabName === 'failed') {
                populateFailedTasks();
            }
        }

        function populateOngoingTasks() {
            const container = document.getElementById('ongoingTasks');
            
            // Sample ongoing queues with different session IDs and timestamps
            const ongoingQueues = [
                {
                    sessionId: 'SES-15-JAN-001',
                    timestamp: '2025-01-15 14:30:25',
                    patients: [
                        { position: 1, name: 'أحمد محمد', phone: '+201000000001', status: 'تم الإرسال', message: 'مرحباً أحمد، ترتيبك 1 والموضع الحالي 3، الوقت المتبقي المقدر 30 دقيقة. نرجو منك الحضور في الوقت المحدد وإحضار جميع الأوراق المطلوبة.' },
                        { position: 2, name: 'فاطمة علي', phone: '+201000000002', status: 'جاري الإرسال', message: 'مرحباً فاطمة، ترتيبك 2 والموضع الحالي 3، الوقت المتبقي المقدر 15 دقيقة. يرجى التأكد من وصولك في الوقت المناسب.' },
                        { position: 3, name: 'محمد حسن', phone: '+201000000003', status: 'في الانتظار', message: 'مرحباً محمد، ترتيبك 3 والموضع الحالي 3، الوقت المتبقي المقدر 0 دقيقة. حان دورك الآن، يرجى التوجه إلى العيادة فوراً.' }
                    ]
                },
                {
                    sessionId: 'SES-15-JAN-002',
                    timestamp: '2025-01-15 15:15:10',
                    patients: [
                        { position: 4, name: 'عائشة أحمد', phone: '+201000000004', status: 'فشل', message: 'تذكير بموعدك عائشة، ترتيبك 4 والوقت المتبقي 45 دقيقة. نتطلع لرؤيتك في العيادة وتقديم أفضل الخدمات الطبية لك.' },
                        { position: 5, name: 'علي محمود', phone: '+201000000005', status: 'تم الإرسال', message: 'تذكير بموعدك علي، ترتيبك 5 والوقت المتبقي 60 دقيقة. يرجى إحضار التقارير الطبية السابقة إن وجدت للمراجعة.' }
                    ]
                }
            ];
            
            container.innerHTML = ongoingQueues.map(queue => `
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-800">جلسة الإرسال: ${queue.sessionId}</h4>
                                <p class="text-sm text-gray-600">الوقت: ${queue.timestamp}</p>
                            </div>
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <button onclick="deleteSelectedOngoingPatients('${queue.sessionId}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-trash ml-1"></i>
                                    <span id="deleteOngoingText-${queue.sessionId}">حذف 0 مريض محدد</span>
                                </button>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <input type="checkbox" id="selectAll-${queue.sessionId}" onchange="toggleSelectAllQueue('${queue.sessionId}')" class="rounded">
                                    <label for="selectAll-${queue.sessionId}" class="text-sm text-gray-600">تحديد الكل</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">تحديد</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الترتيب</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الاسم الكامل</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">رقم الهاتف</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحالة</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                                        <div class="flex items-center justify-between">
                                            <span>الرسالة</span>
                                            <button onclick="toggleOngoingMessages('${queue.sessionId}')" class="text-blue-600 hover:text-blue-700 text-xs">
                                                <span id="toggleOngoingText-${queue.sessionId}">إخفاء</span>
                                            </button>
                                        </div>
                                    </th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${queue.patients.map(patient => {
                                    const statusClass = patient.status === 'فشل' ? 'bg-red-100 text-red-800' : 
                                                       patient.status === 'تم الإرسال' ? 'bg-green-100 text-green-800' : 
                                                       patient.status === 'جاري الإرسال' ? 'bg-blue-100 text-blue-800' :
                                                       'bg-yellow-100 text-yellow-800';
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4">
                                                <input type="checkbox" class="queue-patient-checkbox rounded" value="${patient.position}" data-queue="${queue.sessionId}" onchange="updateOngoingSelectedCount('${queue.sessionId}')">
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-900 font-medium">${patient.position}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${patient.name}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${patient.phone}</td>
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                                    ${patient.status}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-700 max-w-md ongoing-message-${queue.sessionId}">
                                                <div class="whitespace-normal">
                                                    ${patient.message}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex space-x-2 space-x-reverse">
                                                    <button onclick="editOngoingPatient(${patient.position}, '${queue.sessionId}', '${patient.name}', '${patient.phone}')" class="text-blue-600 hover:text-blue-700" title="تعديل">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteOngoingPatient(${patient.position}, '${queue.sessionId}')" class="text-red-600 hover:text-red-700" title="حذف">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }

        function populateFailedTasks() {
            const tbody = document.getElementById('failedTasksTable');
            tbody.innerHTML = '';
            
            if (failedTasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-check-circle text-4xl mb-2"></i>
                            <p>لا توجد مهام فاشلة</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            failedTasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-red-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" class="failed-task-checkbox rounded" value="${task.id}" onchange="updateFailedSelectedCount()">
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">${task.patientName}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${task.phone}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${task.reason}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${task.time}</td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="retryFailedTask(${task.id})" class="text-green-600 hover:text-green-700" title="إعادة المحاولة">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button onclick="editFailedPatient(${task.id}, '${task.patientName}', '${task.phone}')" class="text-blue-600 hover:text-blue-700" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteFailedTask(${task.id})" class="text-red-600 hover:text-red-700" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Modal management
        function showAddQueueModal() {
            document.getElementById('addQueueModal').classList.remove('hidden');
        }

        function showAddPatientModal() {
            document.getElementById('addPatientModal').classList.remove('hidden');
            // Initialize drag functionality for existing slot
            const existingSlot = document.querySelector('.patient-slot');
            if (existingSlot) {
                setupPatientSlotDragDrop(existingSlot);
            }
        }

        function showUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Queue operations
        function addQueue() {
            const doctorName = document.getElementById('newDoctorName').value.trim();
            if (!doctorName) {
                showToast('يرجى إدخال اسم الطبيب', 'error');
                return;
            }
            
            const newQueue = {
                id: queues.length + 1,
                doctorName: doctorName,
                patientCount: 0,
                createdBy: currentUser.username,
                currentPosition: 1,
                estimatedTime: 15
            };
            
            queues.push(newQueue);
            populateQueues();
            closeModal('addQueueModal');
            document.getElementById('newDoctorName').value = '';
            showToast('تم إضافة الطابور بنجاح', 'success');
        }

        function deleteQueue(queueId) {
            if (confirm('هل أنت متأكد من حذف هذا الطابور؟')) {
                queues = queues.filter(q => q.id !== queueId);
                populateQueues();
                showToast('تم حذف الطابور بنجاح', 'success');
            }
        }

        // Patient operations
        function addPatientSlot() {
            const slots = document.getElementById('patientSlots');
            const slotCount = slots.children.length;
            
            if (slotCount >= 50) {
                showToast('الحد الأقصى 50 مريض', 'error');
                return;
            }
            
            const newSlot = document.createElement('div');
            newSlot.className = 'patient-slot border border-gray-200 rounded-lg p-4 mb-4';
            newSlot.innerHTML = `
                <div class="flex items-center mb-3">
                    <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab ml-3" draggable="true">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                    <span class="text-sm text-gray-600">اسحب لإعادة الترتيب</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الكامل</label>
                        <input type="text" class="name-input w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الكامل">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
                        <div class="flex">
                            <select class="country-code px-2 py-2 border border-gray-300 rounded-r-lg bg-gray-50">
                                <option value="+20">+20 (مصر)</option>
                                <option value="+966">+966 (السعودية)</option>
                                <option value="+971">+971 (الإمارات)</option>
                            </select>
                            <input type="tel" class="phone-input flex-1 px-3 py-2 border border-gray-300 rounded-l-lg" placeholder="رقم الهاتف">
                        </div>
                    </div>
                </div>
                <button onclick="removePatientSlot(this)" class="mt-2 text-red-600 hover:text-red-700 text-sm">
                    <i class="fas fa-trash ml-1"></i>
                    حذف هذا المريض
                </button>
            `;
            
            // Add drag and drop functionality
            setupPatientSlotDragDrop(newSlot);
            slots.appendChild(newSlot);
        }

        function setupPatientSlotDragDrop(slot) {
            const dragHandle = slot.querySelector('.drag-handle');
            
            dragHandle.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', 'patient-slot');
                slot.classList.add('dragging');
            });
            
            dragHandle.addEventListener('dragend', () => {
                slot.classList.remove('dragging');
            });
            
            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                slot.classList.add('drop-zone');
            });
            
            slot.addEventListener('dragleave', () => {
                slot.classList.remove('drop-zone');
            });
            
            slot.addEventListener('drop', (e) => {
                e.preventDefault();
                slot.classList.remove('drop-zone');
                
                const draggingSlot = document.querySelector('.patient-slot.dragging');
                if (draggingSlot && draggingSlot !== slot) {
                    const slots = document.getElementById('patientSlots');
                    const allSlots = Array.from(slots.children);
                    const dragIndex = allSlots.indexOf(draggingSlot);
                    const dropIndex = allSlots.indexOf(slot);
                    
                    if (dragIndex < dropIndex) {
                        slot.parentNode.insertBefore(draggingSlot, slot.nextSibling);
                    } else {
                        slot.parentNode.insertBefore(draggingSlot, slot);
                    }
                }
            });
        }

        function removePatientSlot(button) {
            button.closest('.patient-slot').remove();
        }

        function updateQueueMetrics() {
            const currentPosition = document.getElementById('currentPosition').value;
            const estimatedTime = document.getElementById('estimatedTime').value;
            
            if (currentQueue) {
                currentQueue.currentPosition = parseInt(currentPosition) || 1;
                currentQueue.estimatedTime = parseInt(estimatedTime) || 15;
                
                // Update queue in the list
                const queueIndex = queues.findIndex(q => q.id === currentQueue.id);
                if (queueIndex !== -1) {
                    queues[queueIndex] = currentQueue;
                    populateQueues();
                }
                
                showToast('تم تحديث معايير الطابور', 'success');
            }
        }

        function addPatients() {
            const slots = document.querySelectorAll('.patient-slot');
            let newPatients = [];
            
            slots.forEach((slot, index) => {
                const name = slot.querySelector('.name-input').value.trim();
                const countryCode = slot.querySelector('.country-code').value;
                const phone = slot.querySelector('.phone-input').value.trim();
                
                if (name && phone) {
                    newPatients.push({
                        id: patients.length + newPatients.length + 1,
                        position: patients.length + index + 1,
                        name: name,
                        phone: countryCode + phone,
                        status: 'في الانتظار'
                    });
                }
            });
            
            if (newPatients.length === 0) {
                showToast('يرجى إدخال بيانات المرضى', 'error');
                return;
            }
            
            patients.push(...newPatients);
            currentQueue.patientCount += newPatients.length;
            
            populatePatientsTable();
            populateQueues();
            closeModal('addPatientModal');
            
            // Reset form
            document.getElementById('patientSlots').innerHTML = `
                <div class="patient-slot border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-3">
                        <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab ml-3" draggable="true">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <span class="text-sm text-gray-600">اسحب لإعادة الترتيب</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">الاسم الكامل</label>
                            <input type="text" class="name-input w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="أدخل الاسم الكامل">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">رقم الهاتف</label>
                            <div class="flex">
                                <select class="country-code px-2 py-2 border border-gray-300 rounded-r-lg bg-gray-50">
                                    <option value="+20">+20 (مصر)</option>
                                    <option value="+966">+966 (السعودية)</option>
                                    <option value="+971">+971 (الإمارات)</option>
                                </select>
                                <input type="tel" class="phone-input flex-1 px-3 py-2 border border-gray-300 rounded-l-lg" placeholder="رقم الهاتف">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showToast(`تم إضافة ${newPatients.length} مريض بنجاح`, 'success');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.patient-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            const count = selectedCheckboxes.length;
            
            document.getElementById('deleteSelectedText').textContent = count > 0 ? `حذف ${count} محدد` : 'حذف المحدد';
            document.getElementById('sendSelectedText').textContent = count > 0 ? `إرسال لـ ${count} محدد` : 'إرسال للمحدد';
        }

        function deleteSelectedPatients() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast('يرجى تحديد المرضى المراد حذفهم', 'error');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف ${selectedCheckboxes.length} مريض؟`)) {
                const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                patients = patients.filter(p => !selectedIds.includes(p.id));
                currentQueue.patientCount = patients.length;
                
                populatePatientsTable();
                populateQueues();
                document.getElementById('selectAll').checked = false;
                showToast(`تم حذف ${selectedCheckboxes.length} مريض بنجاح`, 'success');
            }
        }

        function sendMessage(patientId) {
            const patient = patients.find(p => p.id === patientId);
            
            if (patient) {
                // Simulate message sending
                showToast(`تم إرسال الرسالة إلى ${patient.name}`, 'success');
                
                // Update patient status randomly for demo
                if (Math.random() > 0.9) {
                    patient.status = 'فشل';
                    // Add to failed tasks
                    failedTasks.push({
                        id: failedTasks.length + 1,
                        patientName: patient.name,
                        phone: patient.phone,
                        reason: 'خطأ في الشبكة',
                        time: new Date().toLocaleString('ar-EG')
                    });
                } else {
                    patient.status = 'تم الإرسال';
                }
                populatePatientsTable();
            }
        }

        function deletePatient(patientId) {
            if (confirm('هل أنت متأكد من حذف هذا المريض؟')) {
                patients = patients.filter(p => p.id !== patientId);
                currentQueue.patientCount = patients.length;
                populatePatientsTable();
                populateQueues();
                showToast('تم حذف المريض بنجاح', 'success');
            }
        }

        function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                const newName = prompt('تعديل اسم المريض:', patient.name);
                if (newName && newName.trim()) {
                    patient.name = newName.trim();
                    populatePatientsTable();
                    showToast('تم تحديث اسم المريض', 'success');
                }
            }
        }

        function reorderPatients(draggedId, targetId) {
            const draggedIndex = patients.findIndex(p => p.id === draggedId);
            const targetIndex = patients.findIndex(p => p.id === targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                // Remove dragged patient and insert at target position
                const draggedPatient = patients.splice(draggedIndex, 1)[0];
                patients.splice(targetIndex, 0, draggedPatient);
                
                // Update positions
                patients.forEach((patient, index) => {
                    patient.position = index + 1;
                });
                
                populatePatientsTable();
                showToast('تم تحديث ترتيب المرضى', 'success');
            }
        }

        function sendToSelectedPatients() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast('يرجى تحديد المرضى المراد الإرسال إليهم', 'error');
                return;
            }
            
            // Show preview modal
            showMessagePreview();
        }

        function showMessagePreview() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const selectedPatients = patients.filter(p => selectedIds.includes(p.id));
            
            // Update preview modal
            document.getElementById('previewMessageTemplate').textContent = selectedMessageTemplate.content;
            document.getElementById('previewPatientCount').textContent = selectedPatients.length;
            
            // Populate preview table
            const tbody = document.getElementById('previewTable');
            tbody.innerHTML = '';
            
            selectedPatients.forEach(patient => {
                // Determine which message template to use based on conditions
                let messageTemplate = selectedMessageTemplate;
                
                for (const condition of messageConditions) {
                    let matches = false;
                    
                    if (condition.type === 'range') {
                        matches = patient.position >= condition.min && patient.position <= condition.max;
                    } else if (condition.type === 'less') {
                        matches = patient.position < condition.value;
                    } else if (condition.type === 'greater') {
                        matches = patient.position > condition.value;
                    }
                    
                    if (matches) {
                        messageTemplate = messageTemplates.find(t => t.id === condition.templateId) || selectedMessageTemplate;
                        break; // Use first matching condition
                    }
                }
                
                const etr = Math.max(0, currentQueue.estimatedTime * (patient.position - currentQueue.currentPosition));
                const personalizedMessage = messageTemplate.content
                    .replace('{PN}', patient.name)
                    .replace('{PQP}', patient.position)
                    .replace('{CQP}', currentQueue.currentPosition)
                    .replace('{ETS}', currentQueue.estimatedTime)
                    .replace('{ETR}', etr);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const isUsingCondition = messageTemplate.id !== selectedMessageTemplate.id;
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">${patient.position}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${patient.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${patient.phone}</td>
                    <td class="px-6 py-4 text-sm text-gray-700 preview-message-cell">
                        ${personalizedMessage}
                        ${isUsingCondition ? `<br><small class="text-blue-600">(${messageTemplate.title})</small>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${Math.random() > 0.1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${Math.random() > 0.1 ? 'سيتم الإرسال' : 'قد يفشل'}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('messagePreviewModal').classList.remove('hidden');
        }

        function confirmSendMessages() {
            const selectedCheckboxes = document.querySelectorAll('.patient-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const selectedPatients = patients.filter(p => selectedIds.includes(p.id));
            
            // Simulate bulk message sending
            let successCount = 0;
            let failCount = 0;
            
            selectedPatients.forEach(patient => {
                // Determine which message template to use based on conditions
                let messageTemplate = selectedMessageTemplate;
                
                for (const condition of messageConditions) {
                    let matches = false;
                    
                    if (condition.type === 'range') {
                        matches = patient.position >= condition.min && patient.position <= condition.max;
                    } else if (condition.type === 'less') {
                        matches = patient.position < condition.value;
                    } else if (condition.type === 'greater') {
                        matches = patient.position > condition.value;
                    }
                    
                    if (matches) {
                        messageTemplate = messageTemplates.find(t => t.id === condition.templateId) || selectedMessageTemplate;
                        break; // Use first matching condition
                    }
                }
                
                // Store which template was used for this patient
                patient.usedTemplate = messageTemplate.title;
                
                if (Math.random() > 0.1) { // 90% success rate
                    patient.status = 'تم الإرسال';
                    successCount++;
                } else {
                    patient.status = 'فشل';
                    failCount++;
                    
                    // Add to failed tasks
                    failedTasks.push({
                        id: failedTasks.length + 1,
                        patientName: patient.name,
                        phone: patient.phone,
                        reason: 'خطأ في الشبكة',
                        time: new Date().toLocaleString('ar-EG')
                    });
                }
            });
            
            populatePatientsTable();
            document.getElementById('selectAll').checked = false;
            updateSelectedCount();
            closeModal('messagePreviewModal');
            
            showToast(`تم إرسال ${successCount} رسالة بنجاح${failCount > 0 ? ` و فشل ${failCount}` : ''}`, 'success');
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                showToast(`تم اختيار الملف: ${file.name}`, 'info');
            }
        }

        function processUpload() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files[0]) {
                showToast('يرجى اختيار ملف Excel', 'error');
                return;
            }
            
            // Simulate file processing
            showToast('جاري معالجة الملف...', 'info');
            
            setTimeout(() => {
                // Add sample patients from "uploaded" file
                const uploadedPatients = [
                    { name: 'سارة أحمد', phone: '+201000000001' },
                    { name: 'محمد علي', phone: '+201000000002' },
                    { name: 'نور حسن', phone: '+201000000003' }
                ];
                
                uploadedPatients.forEach((patient, index) => {
                    patients.push({
                        id: patients.length + index + 1,
                        position: patients.length + index + 1,
                        name: patient.name,
                        phone: patient.phone,
                        status: 'في الانتظار'
                    });
                });
                
                currentQueue.patientCount = patients.length;
                populatePatientsTable();
                populateQueues();
                closeModal('uploadModal');
                
                showToast(`تم رفع ${uploadedPatients.length} مريض بنجاح`, 'success');
            }, 2000);
        }

        // Messages content population
        function populateMessagesContent() {
            const container = document.getElementById('messagesContent');
            const role = currentUser.role;
            
            if (role === 'primary_admin' || role === 'secondary_admin') {
                // For admins, show moderators with their message templates
                const moderators = managedUsers.moderator || [];
                
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- Add Template Button -->
                        <div class="flex justify-end">
                            <button onclick="showAddMessageTemplateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-plus ml-2"></i>
                                إضافة قالب جديد
                            </button>
                        </div>
                        
                        ${moderators.map(moderator => {
                            const moderatorTemplates = messageTemplates.filter(t => t.moderator === moderator.fullName);
                            const adminTemplates = messageTemplates.filter(t => !t.moderator);
                            
                            return `
                                <div class="bg-white border border-gray-200 rounded-lg">
                                    <div class="flex items-center justify-between p-4 bg-blue-50 border-b border-blue-200 rounded-t-lg">
                                        <div>
                                            <h4 class="font-medium text-blue-800">${moderator.fullName}</h4>
                                            <p class="text-sm text-blue-600">${moderatorTemplates.length} قالب رسالة</p>
                                        </div>
                                        <button onclick="toggleModeratorMessages('${moderator.id}')" class="text-blue-600 hover:text-blue-700">
                                            <i class="fas fa-chevron-down" id="chevron-msg-${moderator.id}"></i>
                                        </button>
                                    </div>
                                    <div id="messages-mod-${moderator.id}" class="hidden p-4 space-y-4">
                                        ${moderatorTemplates.map(template => `
                                            <div class="border border-gray-200 rounded-lg p-4">
                                                <div class="flex items-center justify-between mb-2">
                                                    <h5 class="font-medium text-gray-800">${template.title}</h5>
                                                    <div class="flex space-x-2 space-x-reverse">
                                                        <button onclick="editMessageTemplate(${template.id})" class="text-blue-600 hover:text-blue-700">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button onclick="deleteMessageTemplate(${template.id})" class="text-red-600 hover:text-red-700">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <p class="text-gray-600 text-sm">${template.content}</p>
                                            </div>
                                        `).join('')}
                                        ${moderatorTemplates.length === 0 ? '<p class="text-gray-500 text-center py-4">لا توجد قوالب رسائل</p>' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        <!-- Admin Templates -->
                        ${messageTemplates.filter(t => !t.moderator).length > 0 ? `
                            <div class="bg-white border border-gray-200 rounded-lg">
                                <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                                    <h4 class="font-medium text-gray-800">قوالب المدير</h4>
                                </div>
                                <div class="p-4 space-y-4">
                                    ${messageTemplates.filter(t => !t.moderator).map(template => `
                                        <div class="border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="font-medium text-gray-800">${template.title}</h5>
                                                <div class="flex space-x-2 space-x-reverse">
                                                    <button onclick="editMessageTemplate(${template.id})" class="text-blue-600 hover:text-blue-700">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteMessageTemplate(${template.id})" class="text-red-600 hover:text-red-700">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="text-gray-600 text-sm">${template.content}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // For moderators and users, show simple template list
                container.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-gray-800">قوالب الرسائل</h3>
                            <button onclick="showAddMessageTemplateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-plus ml-2"></i>
                                إضافة قالب جديد
                            </button>
                        </div>
                        
                        <div id="messageTemplates" class="space-y-4">
                            <!-- Message templates will be populated here -->
                        </div>
                    </div>
                `;
                populateMessageTemplates();
            }
        }

        function toggleModeratorMessages(moderatorId) {
            const messagesDiv = document.getElementById(`messages-mod-${moderatorId}`);
            const chevron = document.getElementById(`chevron-msg-${moderatorId}`);
            
            if (messagesDiv.classList.contains('hidden')) {
                messagesDiv.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                messagesDiv.classList.add('hidden');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }

        // Message templates
        function populateMessageTemplates() {
            const container = document.getElementById('messageTemplates');
            container.innerHTML = '';
            
            messageTemplates.forEach(template => {
                const templateElement = document.createElement('div');
                templateElement.className = 'border border-gray-200 rounded-lg p-4';
                templateElement.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <h4 class="font-medium text-gray-800">${template.title}</h4>
                            <p class="text-xs text-gray-500">
                                ${template.moderator ? `المشرف: ${template.moderator}` : 'المدير'}
                            </p>
                        </div>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="editMessageTemplate(${template.id})" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMessageTemplate(${template.id})" class="text-red-600 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm">${template.content}</p>
                `;
                container.appendChild(templateElement);
            });
        }

        function showMessageSelectionModal() {
            document.getElementById('messageSelectionModal').classList.remove('hidden');
            populateMessageTemplatesList();
        }

        function populateMessageTemplatesList() {
            const container = document.getElementById('messageTemplatesList');
            container.innerHTML = '';
            
            messageTemplates.forEach(template => {
                const templateElement = document.createElement('div');
                templateElement.className = `border border-gray-200 rounded-lg p-4 cursor-pointer hover:bg-gray-50 ${selectedMessageTemplate.id === template.id ? 'border-blue-500 bg-blue-50' : ''}`;
                templateElement.onclick = () => selectMessageTemplate(template.id);
                
                templateElement.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-800">${template.title}</h4>
                        <div class="w-4 h-4 rounded-full border-2 ${selectedMessageTemplate.id === template.id ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}"></div>
                    </div>
                    <p class="text-gray-600 text-sm">${template.content}</p>
                `;
                
                container.appendChild(templateElement);
            });
        }

        function selectMessageTemplate(templateId) {
            selectedMessageTemplate = messageTemplates.find(t => t.id === templateId);
            populateMessageTemplatesList();
        }

        function addCondition() {
            if (messageConditions.length >= 5) {
                showToast('الحد الأقصى 5 شروط', 'error');
                return;
            }
            
            const conditionId = Date.now();
            const condition = {
                id: conditionId,
                type: 'range',
                min: 1,
                max: 5,
                templateId: messageTemplates[0].id
            };
            
            messageConditions.push(condition);
            renderConditions();
        }

        function removeCondition(conditionId) {
            messageConditions = messageConditions.filter(c => c.id !== conditionId);
            renderConditions();
        }

        function renderConditions() {
            const container = document.getElementById('conditionsList');
            container.innerHTML = '';
            
            messageConditions.forEach(condition => {
                const conditionElement = document.createElement('div');
                conditionElement.className = 'border border-gray-200 rounded-lg p-3';
                
                conditionElement.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="font-medium text-gray-800">شرط ${messageConditions.indexOf(condition) + 1}</h5>
                        <button onclick="removeCondition(${condition.id})" class="text-red-600 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نوع الشرط</label>
                            <select onchange="updateConditionType(${condition.id}, this.value)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="range" ${condition.type === 'range' ? 'selected' : ''}>نطاق</option>
                                <option value="less" ${condition.type === 'less' ? 'selected' : ''}>أقل من</option>
                                <option value="greater" ${condition.type === 'greater' ? 'selected' : ''}>أكثر من</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ترتيب المرضى</label>
                            <div class="flex space-x-1 space-x-reverse">
                                ${condition.type === 'range' ? `
                                    <input type="number" value="${condition.min}" onchange="updateConditionValue(${condition.id}, 'min', this.value)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="من الترتيب">
                                    <input type="number" value="${condition.max}" onchange="updateConditionValue(${condition.id}, 'max', this.value)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="إلى الترتيب">
                                ` : `
                                    <input type="number" value="${condition.value || 1}" onchange="updateConditionValue(${condition.id}, 'value', this.value)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm" placeholder="الترتيب">
                                `}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">قالب الرسالة</label>
                            <select onchange="updateConditionTemplate(${condition.id}, this.value)" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                ${messageTemplates.map(template => 
                                    `<option value="${template.id}" ${condition.templateId === template.id ? 'selected' : ''}>${template.title}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                `;
                
                container.appendChild(conditionElement);
            });
        }

        function updateConditionType(conditionId, type) {
            const condition = messageConditions.find(c => c.id === conditionId);
            if (condition) {
                condition.type = type;
                if (type !== 'range') {
                    condition.value = condition.min || 1;
                    delete condition.min;
                    delete condition.max;
                } else {
                    condition.min = condition.value || 1;
                    condition.max = (condition.value || 1) + 4;
                    delete condition.value;
                }
                renderConditions();
            }
        }

        function updateConditionValue(conditionId, field, value) {
            const condition = messageConditions.find(c => c.id === conditionId);
            if (condition) {
                condition[field] = parseInt(value) || 1;
            }
        }

        function updateConditionTemplate(conditionId, templateId) {
            const condition = messageConditions.find(c => c.id === conditionId);
            if (condition) {
                condition.templateId = parseInt(templateId);
            }
        }

        function applyMessageSelection() {
            // Update display
            document.getElementById('selectedMessageText').textContent = selectedMessageTemplate.content;
            
            let conditionsText = 'الرسالة الافتراضية';
            if (messageConditions.length > 0) {
                conditionsText += ' مع ' + messageConditions.length + ' شرط';
                const conditionDescriptions = messageConditions.map(condition => {
                    const template = messageTemplates.find(t => t.id === condition.templateId);
                    if (condition.type === 'range') {
                        return `الترتيب من ${condition.min} إلى ${condition.max}: ${template.title}`;
                    } else if (condition.type === 'less') {
                        return `الترتيب أقل من ${condition.value}: ${template.title}`;
                    } else {
                        return `الترتيب أكثر من ${condition.value}: ${template.title}`;
                    }
                });
                conditionsText += '<br>' + conditionDescriptions.join('<br>');
            }
            
            document.getElementById('messageConditions').innerHTML = `
                <p><strong>الشروط:</strong> ${conditionsText}</p>
            `;
            
            closeModal('messageSelectionModal');
            showToast('تم تحديث الرسالة الافتراضية', 'success');
        }

        function showAddMessageTemplateModal() {
            document.getElementById('addMessageTemplateModal').classList.remove('hidden');
        }

        function insertVariable(variable) {
            const textarea = document.getElementById('newMessageContent');
            const cursorPosition = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPosition);
            const textAfter = textarea.value.substring(cursorPosition);
            
            // Insert variable at cursor position or at the end if no cursor position
            if (cursorPosition !== undefined) {
                textarea.value = textBefore + variable + textAfter;
                // Set cursor position after the inserted variable
                textarea.setSelectionRange(cursorPosition + variable.length, cursorPosition + variable.length);
            } else {
                textarea.value += variable;
            }
            
            // Focus back on textarea
            textarea.focus();
        }

        function addMessageTemplate() {
            const title = document.getElementById('newMessageTitle').value.trim();
            const content = document.getElementById('newMessageContent').value.trim();
            
            if (!title || !content) {
                showToast('يرجى إدخال عنوان ومحتوى الرسالة', 'error');
                return;
            }
            
            const newTemplate = {
                id: messageTemplates.length + 1,
                title: title,
                content: content,
                createdBy: currentUser.username
            };
            
            // Assign moderator relationship based on user role
            if (currentUser.role === 'moderator') {
                newTemplate.moderator = currentUser.name;
            } else if (currentUser.role === 'user') {
                // Find the moderator for this user
                const userRecord = managedUsers.user.find(u => u.username === currentUser.username);
                newTemplate.moderator = userRecord ? userRecord.moderator : null;
            } else {
                // Admin created template
                newTemplate.moderator = null;
            }
            
            messageTemplates.push(newTemplate);
            populateMessageTemplates();
            closeModal('addMessageTemplateModal');
            
            // Reset form
            document.getElementById('newMessageTitle').value = '';
            document.getElementById('newMessageContent').value = '';
            
            showToast('تم إضافة قالب الرسالة بنجاح', 'success');
        }

        function editMessageTemplate(templateId) {
            const template = messageTemplates.find(t => t.id === templateId);
            if (template) {
                const newTitle = prompt('تعديل عنوان القالب:', template.title);
                if (newTitle && newTitle.trim()) {
                    template.title = newTitle.trim();
                    populateMessageTemplates();
                    showToast('تم تحديث قالب الرسالة', 'success');
                }
            }
        }

        function deleteMessageTemplate(templateId) {
            if (confirm('هل أنت متأكد من حذف هذا القالب؟')) {
                messageTemplates = messageTemplates.filter(t => t.id !== templateId);
                populateMessageTemplates();
                showToast('تم حذف قالب الرسالة', 'success');
            }
        }

        function retryFailedTask(taskId) {
            const task = failedTasks.find(t => t.id === taskId);
            if (task) {
                // Simulate retry
                if (Math.random() > 0.3) { // 70% success rate on retry
                    failedTasks = failedTasks.filter(t => t.id !== taskId);
                    showToast(`تم إرسال الرسالة بنجاح إلى ${task.patientName}`, 'success');
                } else {
                    task.time = new Date().toLocaleString('ar-EG');
                    showToast(`فشل في إعادة الإرسال إلى ${task.patientName}`, 'error');
                }
                populateFailedTasks();
            }
        }

        function retryAllFailed() {
            if (failedTasks.length === 0) {
                showToast('لا توجد مهام فاشلة لإعادة المحاولة', 'info');
                return;
            }
            
            let successCount = 0;
            const totalTasks = failedTasks.length;
            
            failedTasks = failedTasks.filter(task => {
                if (Math.random() > 0.3) { // 70% success rate
                    successCount++;
                    return false; // Remove from failed tasks
                } else {
                    task.time = new Date().toLocaleString('ar-EG');
                    return true; // Keep in failed tasks
                }
            });
            
            populateFailedTasks();
            showToast(`تم إعادة إرسال ${successCount} من ${totalTasks} رسالة بنجاح`, 'success');
        }

        function deleteFailedTask(taskId) {
            if (confirm('هل أنت متأكد من حذف هذه المهمة الفاشلة؟')) {
                failedTasks = failedTasks.filter(t => t.id !== taskId);
                populateFailedTasks();
                showToast('تم حذف المهمة الفاشلة', 'success');
            }
        }

        function pauseAllTasks() {
            showToast('تم إيقاف جميع المهام مؤقتاً', 'warning');
        }

        function toggleSelectAllQueue(sessionId) {
            const selectAll = document.getElementById(`selectAll-${sessionId}`);
            const checkboxes = document.querySelectorAll(`input[data-queue="${sessionId}"]`);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function editOngoingPatient(position, sessionId) {
            showToast(`تعديل بيانات المريض في الترتيب ${position} من الجلسة ${sessionId}`, 'info');
        }

        function deleteOngoingPatient(position, sessionId) {
            if (confirm(`هل أنت متأكد من حذف المريض في الترتيب ${position}؟`)) {
                showToast(`تم حذف المريض من الجلسة ${sessionId}`, 'success');
                populateOngoingTasks();
            }
        }

        function updateModeratorQuota(moderatorId, quotaType, value) {
            const moderator = managedUsers.moderator.find(m => m.id === moderatorId);
            if (moderator) {
                if (quotaType === 'messages') {
                    moderator.messagesQuota = parseInt(value) || 0;
                } else if (quotaType === 'queues') {
                    moderator.queuesQuota = parseInt(value) || 0;
                }
                showToast(`تم تحديث حصة ${quotaType === 'messages' ? 'الرسائل' : 'الطوابير'} للمشرف ${moderator.fullName}`, 'success');
            }
        }

        function editFailedTask(taskId) {
            const task = failedTasks.find(t => t.id === taskId);
            if (task) {
                const newPhone = prompt('تعديل رقم الهاتف:', task.phone);
                if (newPhone && newPhone.trim()) {
                    task.phone = newPhone.trim();
                    populateFailedTasks();
                    showToast('تم تحديث رقم الهاتف', 'success');
                }
            }
        }

        function populateManagementContent() {
            const container = document.getElementById('managementContent');
            const role = currentUser.role;
            
            if (role === 'primary_admin') {
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- Navigation Buttons -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="showUserManagementTable('secondary_admin')" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-user-shield"></i>
                                <span>المديرين الثانويين</span>
                            </button>
                            <button onclick="showCombinedUserTable()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-users"></i>
                                <span>المشرفين والمستخدمين</span>
                            </button>
                        </div>
                        
                        <!-- User Management Table Container -->
                        <div id="userManagementContainer" class="hidden">
                            <!-- Content will be populated dynamically -->
                        </div>
                        
                        <!-- Account Information Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">معلومات الحساب</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأول</div>
                                    <div class="text-lg text-gray-900" id="currentFirstNameDisplay">المدير</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأخير</div>
                                    <div class="text-lg text-gray-900" id="currentLastNameDisplay">الأساسي</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">اسم المستخدم</div>
                                    <div class="text-lg text-gray-900" id="currentUsernameDisplay">admin</div>
                                </div>
                            </div>
                            <button onclick="showAccountInfoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-edit ml-1"></i>
                                تعديل معلومات الحساب
                            </button>
                        </div>
                    </div>
                `;
            } else if (role === 'secondary_admin') {
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- Navigation Button -->
                        <div class="grid grid-cols-1 gap-4">
                            <button onclick="showCombinedUserTable()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-users"></i>
                                <span>المشرفين والمستخدمين</span>
                            </button>
                        </div>
                        
                        <!-- User Management Table Container -->
                        <div id="userManagementContainer" class="hidden">
                            <!-- Content will be populated dynamically -->
                        </div>
                        
                        <!-- Account Information Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">معلومات الحساب</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأول</div>
                                    <div class="text-lg text-gray-900" id="currentFirstNameDisplay">المدير</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأخير</div>
                                    <div class="text-lg text-gray-900" id="currentLastNameDisplay">الثانوي</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">اسم المستخدم</div>
                                    <div class="text-lg text-gray-900" id="currentUsernameDisplay">admin2</div>
                                </div>
                            </div>
                            <button onclick="showAccountInfoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-edit ml-1"></i>
                                تعديل معلومات الحساب
                            </button>
                        </div>
                    </div>
                `;
            } else if (role === 'moderator') {
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- Navigation Button -->
                        <div class="grid grid-cols-1 gap-4">
                            <button onclick="showUserManagementTable('user')" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center space-x-2 space-x-reverse">
                                <i class="fas fa-user"></i>
                                <span>المستخدمين تحت إشرافي</span>
                            </button>
                        </div>
                        
                        <!-- User Management Table Container -->
                        <div id="userManagementContainer" class="hidden">
                            <!-- Content will be populated dynamically -->
                        </div>
                        
                        <!-- WhatsApp Authentication Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">مصادقة واتساب</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">حالة الجلسة</label>
                                    <span id="whatsappSessionStatus" class="px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800">متصل</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">آخر مصادقة</label>
                                    <span id="lastAuthTimestamp" class="text-sm text-gray-600">2025-01-15 08:45 AM</span>
                                </div>
                                <div>
                                    <button onclick="showWhatsAppAuthModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        <i class="fab fa-whatsapp ml-1"></i>
                                        مصادقة جلسة واتساب
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Information Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">معلومات الحساب</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأول</div>
                                    <div class="text-lg text-gray-900" id="currentFirstNameDisplay">محمد</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأخير</div>
                                    <div class="text-lg text-gray-900" id="currentLastNameDisplay">أحمد</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">اسم المستخدم</div>
                                    <div class="text-lg text-gray-900" id="currentUsernameDisplay">mod1</div>
                                </div>
                            </div>
                            <button onclick="showAccountInfoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-edit ml-1"></i>
                                تعديل معلومات الحساب
                            </button>
                        </div>
                        
                        <!-- My Statistics -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">إحصائياتي</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-600">3 من 5</div>
                                    <div class="text-sm text-gray-600">الطوابير المنشأة</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">45 من 100</div>
                                    <div class="text-sm text-gray-600">الرسائل المرسلة</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600">2</div>
                                    <div class="text-sm text-gray-600">المستخدمين المُدارين</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="space-y-6">
                        <!-- WhatsApp Authentication Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">مصادقة واتساب</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">حالة الجلسة</label>
                                    <span id="whatsappSessionStatus" class="px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800">متصل</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">آخر مصادقة</label>
                                    <span id="lastAuthTimestamp" class="text-sm text-gray-600">2025-01-15 11:00 AM</span>
                                </div>
                                <div>
                                    <button onclick="showWhatsAppAuthModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                        <i class="fab fa-whatsapp ml-1"></i>
                                        مصادقة جلسة واتساب
                                    </button>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <p class="text-sm text-blue-700">
                                    <i class="fas fa-info-circle ml-1"></i>
                                    جلسة واتساب مشتركة مع المشرف: محمد أحمد
                                </p>
                            </div>
                        </div>
                        
                        <!-- Account Information Section -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h3 class="font-bold text-gray-800 mb-4">معلومات الحساب</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأول</div>
                                    <div class="text-lg text-gray-900" id="currentFirstNameDisplay">نور</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">الاسم الأخير</div>
                                    <div class="text-lg text-gray-900" id="currentLastNameDisplay">محمد</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 mb-1">اسم المستخدم</div>
                                    <div class="text-lg text-gray-900" id="currentUsernameDisplay">user1</div>
                                </div>
                            </div>
                            <button onclick="showAccountInfoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-edit ml-1"></i>
                                تعديل معلومات الحساب
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Sample user data
        let managedUsers = {
            secondary_admin: [
                { id: 1, firstName: 'أحمد', lastName: 'محمد علي', fullName: 'أحمد محمد علي', username: 'admin2', password: 'A7k9M2pQ', lastAuth: '2025-01-15 09:30 AM' },
                { id: 2, firstName: 'فاطمة', lastName: 'حسن', fullName: 'فاطمة حسن', username: 'admin3', password: 'F3h8N5wR', lastAuth: '2025-01-14 02:15 PM' }
            ],
            moderator: [
                { id: 3, firstName: 'محمد', lastName: 'أحمد', fullName: 'محمد أحمد', username: 'mod1', password: 'M9a2K7lP', messagesQuota: 100, queuesQuota: 5, consumedMessages: 45, consumedQueues: 3, whatsappStatus: 'متصل', lastAuth: '2025-01-15 08:45 AM' },
                { id: 4, firstName: 'سارة', lastName: 'علي', fullName: 'سارة علي', username: 'mod2', password: 'S4r6A8nT', messagesQuota: 80, queuesQuota: 3, consumedMessages: 25, consumedQueues: 2, whatsappStatus: 'متصل', lastAuth: '2025-01-15 10:20 AM' },
                { id: 5, firstName: 'عمر', lastName: 'حسن', fullName: 'عمر حسن', username: 'mod3', password: 'O1m5H3qW', messagesQuota: 120, queuesQuota: 6, consumedMessages: 85, consumedQueues: 4, whatsappStatus: 'غير متصل', lastAuth: '2025-01-13 04:30 PM' }
            ],
            user: [
                { id: 6, firstName: 'نور', lastName: 'محمد', fullName: 'نور محمد', username: 'user1', password: 'N6o4M9rE', moderator: 'محمد أحمد', lastAuth: '2025-01-15 11:00 AM' },
                { id: 7, firstName: 'ليلى', lastName: 'أحمد', fullName: 'ليلى أحمد', username: 'user2', password: 'L2i8A5hD', moderator: 'سارة علي', lastAuth: '2025-01-15 09:15 AM' },
                { id: 8, firstName: 'خالد', lastName: 'علي', fullName: 'خالد علي', username: 'user3', password: 'K7h3A1lI', moderator: 'محمد أحمد', lastAuth: '2025-01-14 06:45 PM' },
                { id: 9, firstName: 'مريم', lastName: 'حسن', fullName: 'مريم حسن', username: 'user4', password: 'M4r9H6sN', moderator: 'عمر حسن', lastAuth: '2025-01-15 07:30 AM' }
            ]
        };

        function showCombinedUserTable() {
            const container = document.getElementById('userManagementContainer');
            const moderators = managedUsers.moderator || [];
            
            container.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">المشرفين والمستخدمين</h3>
                                <p class="text-sm text-gray-600">${moderators.length} مشرف</p>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="showAddUserModal('moderator')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-plus ml-1"></i>
                                    إضافة مشرف
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">معرف المستخدم</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الاسم الكامل</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">اسم المستخدم</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحصة المتبقية</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">حالة واتساب</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">آخر مصادقة</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${moderators.map(moderator => {
                                    const moderatorUsers = managedUsers.user.filter(u => u.moderator === moderator.fullName);
                                    return `
                                        <tr class="hover:bg-gray-50 bg-blue-50">
                                            <td class="px-6 py-4 text-sm text-gray-900 font-medium">${moderator.id}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">
                                                <div class="flex items-center">
                                                    <i class="fas fa-user-tie text-blue-600 ml-2"></i>
                                                    ${moderator.fullName}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${moderator.username}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">
                                                <div class="space-y-1">
                                                    <div class="flex items-center space-x-2 space-x-reverse">
                                                        <span>الرسائل: ${(moderator.messagesQuota || 0) - (moderator.consumedMessages || 0)}</span>
                                                    </div>
                                                    <div class="flex items-center space-x-2 space-x-reverse">
                                                        <span>الطوابير: ${(moderator.queuesQuota || 0) - (moderator.consumedQueues || 0)}</span>
                                                    </div>
                                                    <button onclick="showQuotaManagementModal(${moderator.id})" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition duration-200">
                                                        إدارة الحصة
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full ${moderator.whatsappStatus === 'متصل' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                    ${moderator.whatsappStatus}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-500">${moderator.lastAuth}</td>
                                            <td class="px-6 py-4">
                                                <div class="flex space-x-2 space-x-reverse">
                                                    <button onclick="toggleModeratorUsers(${moderator.id})" class="text-blue-600 hover:text-blue-700" title="عرض/إخفاء المستخدمين">
                                                        <i class="fas fa-chevron-down" id="chevron-${moderator.id}"></i>
                                                    </button>
                                                    <button onclick="editUser(${moderator.id}, 'moderator')" class="text-blue-600 hover:text-blue-700" title="تعديل">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteUser(${moderator.id}, 'moderator')" class="text-red-600 hover:text-red-700" title="حذف">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr id="users-${moderator.id}" class="hidden">
                                            <td colspan="7" class="px-6 py-0">
                                                <div class="bg-gray-50 rounded-lg p-4 m-2">
                                                    <div class="flex items-center justify-between mb-3">
                                                        <h4 class="font-medium text-gray-800">المستخدمين تحت إشراف ${moderator.fullName}</h4>
                                                        <button onclick="showAddUserModal('user', ${moderator.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition duration-200">
                                                            <i class="fas fa-plus ml-1"></i>
                                                            إضافة مستخدم
                                                        </button>
                                                    </div>
                                                    ${moderatorUsers.length > 0 ? `
                                                        <div class="overflow-x-auto">
                                                            <table class="w-full">
                                                                <thead class="bg-white">
                                                                    <tr>
                                                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">معرف المستخدم</th>
                                                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">الاسم الكامل</th>
                                                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">اسم المستخدم</th>
                                                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">آخر مصادقة</th>
                                                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">الإجراءات</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody class="divide-y divide-gray-200">
                                                                    ${moderatorUsers.map(user => `
                                                                        <tr class="hover:bg-white">
                                                                            <td class="px-4 py-2 text-sm text-gray-900">${user.id}</td>
                                                                            <td class="px-4 py-2 text-sm text-gray-900">
                                                                                <div class="flex items-center">
                                                                                    <i class="fas fa-user text-green-600 ml-2"></i>
                                                                                    ${user.fullName}
                                                                                </div>
                                                                            </td>
                                                                            <td class="px-4 py-2 text-sm text-gray-900">${user.username}</td>
                                                                            <td class="px-4 py-2 text-sm text-gray-500">${user.lastAuth}</td>
                                                                            <td class="px-4 py-2">
                                                                                <div class="flex space-x-2 space-x-reverse">
                                                                                    <button onclick="editUser(${user.id}, 'user')" class="text-blue-600 hover:text-blue-700" title="تعديل">
                                                                                        <i class="fas fa-edit"></i>
                                                                                    </button>
                                                                                    <button onclick="deleteUser(${user.id}, 'user')" class="text-red-600 hover:text-red-700" title="حذف">
                                                                                        <i class="fas fa-trash"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                    `).join('')}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    ` : `
                                                        <p class="text-gray-500 text-center py-4">لا يوجد مستخدمين تحت إشراف هذا المشرف</p>
                                                    `}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
        }

        function toggleModeratorUsers(moderatorId) {
            const usersRow = document.getElementById(`users-${moderatorId}`);
            const chevron = document.getElementById(`chevron-${moderatorId}`);
            
            if (usersRow.classList.contains('hidden')) {
                usersRow.classList.remove('hidden');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            } else {
                usersRow.classList.add('hidden');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            }
        }

        function showUserManagementTable(userType) {
            const container = document.getElementById('userManagementContainer');
            const users = managedUsers[userType] || [];
            
            const roleNames = {
                'secondary_admin': 'المديرين الثانويين',
                'moderator': 'المشرفين',
                'user': 'المستخدمين'
            };
            
            const roleName = roleNames[userType];
            const count = users.length;
            
            container.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${roleName}</h3>
                                <p class="text-sm text-gray-600">${count} ${roleName.slice(0, -2)}</p>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button onclick="showAddUserModal('${userType}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                                    <i class="fas fa-plus ml-1"></i>
                                    إضافة ${userType === 'secondary_admin' ? 'مدير' : userType === 'moderator' ? 'مشرف' : 'مستخدم'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">معرف المستخدم</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الاسم الكامل</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">اسم المستخدم</th>
                                    ${userType === 'user' ? '<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">المشرف</th>' : ''}
                                    ${userType === 'moderator' ? '<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الحصة المتبقية</th>' : ''}
                                    ${userType === 'moderator' ? '<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">حالة واتساب</th>' : ''}
                                    ${userType === 'moderator' ? '<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">آخر مصادقة</th>' : ''}
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${users.map(user => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900 font-medium">${user.id}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${user.fullName}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900">${user.username}</td>
                                        ${userType === 'user' ? `<td class="px-6 py-4 text-sm text-gray-900">${user.moderator}</td>` : ''}
                                        ${userType === 'moderator' ? `
                                            <td class="px-6 py-4 text-sm text-gray-900">
                                                <div class="space-y-1">
                                                    <div class="flex items-center space-x-2 space-x-reverse">
                                                        <span>الرسائل:</span>
                                                        <input type="number" value="${user.messagesQuota}" onchange="updateModeratorQuota(${user.id}, 'messages', this.value)" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                    </div>
                                                    <div class="flex items-center space-x-2 space-x-reverse">
                                                        <span>الطوابير:</span>
                                                        <input type="number" value="${user.queuesQuota}" onchange="updateModeratorQuota(${user.id}, 'queues', this.value)" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                    </div>
                                                </div>
                                            </td>
                                        ` : ''}
                                        ${userType === 'moderator' ? `
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full ${user.whatsappStatus === 'متصل' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                    ${user.whatsappStatus}
                                                </span>
                                            </td>
                                        ` : ''}
                                        ${userType === 'moderator' ? `<td class="px-6 py-4 text-sm text-gray-500">${user.lastAuth}</td>` : ''}
                                        <td class="px-6 py-4">
                                            <div class="flex space-x-2 space-x-reverse">
                                                <button onclick="editUser(${user.id}, '${userType}')" class="text-blue-600 hover:text-blue-700" title="تعديل">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteUser(${user.id}, '${userType}')" class="text-red-600 hover:text-red-700" title="حذف">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
        }

        function showAddUserModal(userType, moderatorId = null) {
            const roleNames = {
                'secondary_admin': 'مدير ثانوي',
                'moderator': 'مشرف',
                'user': 'مستخدم'
            };
            
            const roleName = roleNames[userType];
            const firstName = prompt(`أدخل الاسم الأول للـ${roleName} الجديد:`);
            
            if (!firstName || !firstName.trim()) {
                showToast('يرجى إدخال الاسم الأول', 'error');
                return;
            }
            
            const lastName = prompt(`أدخل الاسم الأخير للـ${roleName} الجديد:`);
            
            if (!lastName || !lastName.trim()) {
                showToast('يرجى إدخال الاسم الأخير', 'error');
                return;
            }
            
            const username = prompt(`أدخل اسم المستخدم للـ${roleName} الجديد:`);
            
            if (!username || !username.trim()) {
                showToast('يرجى إدخال اسم المستخدم', 'error');
                return;
            }
            
            // Check if username already exists
            const allUsers = [...managedUsers.secondary_admin, ...managedUsers.moderator, ...managedUsers.user];
            if (allUsers.some(u => u.username === username.trim())) {
                showToast('اسم المستخدم موجود بالفعل', 'error');
                return;
            }
            
            // Generate auto password
            const autoPassword = generateRandomPassword();
            
            const newUser = {
                id: allUsers.length > 0 ? Math.max(...allUsers.map(u => u.id)) + 1 : 1,
                firstName: firstName.trim(),
                lastName: lastName.trim(),
                fullName: `${firstName.trim()} ${lastName.trim()}`,
                username: username.trim(),
                password: autoPassword
            };
            
            // Add role-specific properties
            if (userType === 'moderator') {
                newUser.messagesQuota = 100;
                newUser.queuesQuota = 5;
                newUser.consumedMessages = 0;
                newUser.consumedQueues = 0;
                newUser.whatsappStatus = 'غير متصل';
                newUser.lastAuth = 'لم يسجل دخول بعد';
            } else if (userType === 'user') {
                const moderator = managedUsers.moderator.find(m => m.id === moderatorId);
                newUser.moderator = moderator ? moderator.fullName : 'غير محدد';
                newUser.lastAuth = 'لم يسجل دخول بعد';
            } else if (userType === 'secondary_admin') {
                newUser.lastAuth = 'لم يسجل دخول بعد';
            }
            
            managedUsers[userType].push(newUser);
            
            // Refresh the appropriate table
            if (userType === 'user' && moderatorId) {
                showCombinedUserTable();
            } else if (userType === 'secondary_admin') {
                showUserManagementTable('secondary_admin');
            } else if (userType === 'moderator') {
                showCombinedUserTable();
            } else {
                showUserManagementTable(userType);
            }
            
            showToast(`تم إضافة ${roleName} بنجاح. كلمة المرور: ${autoPassword}`, 'success');
        }

        function editUser(userId, userType) {
            const user = managedUsers[userType].find(u => u.id === userId);
            if (user) {
                showToast(`تعديل بيانات ${user.fullName}`, 'info');
            }
        }

        function deleteUser(userId, userType) {
            const user = managedUsers[userType].find(u => u.id === userId);
            if (user && confirm(`هل أنت متأكد من حذف المستخدم ${user.fullName}؟`)) {
                managedUsers[userType] = managedUsers[userType].filter(u => u.id !== userId);
                showUserManagementTable(userType);
                showToast(`تم حذف المستخدم ${user.fullName}`, 'success');
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 space-x-reverse`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Account management functions
        function showAccountInfoModal() {
            // Populate current values
            const names = currentUser.name.split(' ');
            document.getElementById('editFirstName').value = names[0] || '';
            document.getElementById('editLastName').value = names.slice(1).join(' ') || '';
            document.getElementById('editUsername').value = currentUser.username;
            
            document.getElementById('accountInfoModal').classList.remove('hidden');
        }

        function togglePasswordChange() {
            const section = document.getElementById('passwordChangeSection');
            const toggleText = document.getElementById('passwordToggleText');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggleText.textContent = 'إخفاء';
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            } else {
                section.classList.add('hidden');
                toggleText.textContent = 'إظهار';
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            }
        }

        function saveAccountInfo() {
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!firstName || !lastName || !username) {
                showToast('يرجى إدخال جميع البيانات المطلوبة', 'error');
                return;
            }
            
            // Check if password change is requested
            if (currentPassword || newPassword || confirmPassword) {
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showToast('يرجى إدخال جميع حقول كلمة المرور', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showToast('كلمة المرور الجديدة غير متطابقة', 'error');
                    return;
                }
                
                if (currentPassword !== currentUser.password) {
                    showToast('كلمة المرور الحالية غير صحيحة', 'error');
                    return;
                }
                
                // Update password
                currentUser.password = newPassword;
            }
            
            // Update user info
            currentUser.name = `${firstName} ${lastName}`;
            currentUser.username = username;
            
            // Update display
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('currentFirstNameDisplay').textContent = firstName;
            document.getElementById('currentLastNameDisplay').textContent = lastName;
            document.getElementById('currentUsernameDisplay').textContent = username;
            
            closeModal('accountInfoModal');
            showToast('تم تحديث معلومات الحساب بنجاح', 'success');
            
            // Reset password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordChangeSection').classList.add('hidden');
        }

        function showWhatsAppAuthModal() {
            document.getElementById('whatsappAuthModal').classList.remove('hidden');
        }

        function authenticateWhatsApp() {
            // Simulate authentication process
            showToast('جاري المصادقة...', 'info');
            
            setTimeout(() => {
                // Update status
                const statusElement = document.getElementById('whatsappSessionStatus');
                statusElement.textContent = 'متصل';
                statusElement.className = 'px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-800';
                
                // Update timestamp
                document.getElementById('lastAuthTimestamp').textContent = new Date().toLocaleString('ar-EG');
                
                closeModal('whatsappAuthModal');
                showToast('تم تأكيد مصادقة واتساب بنجاح', 'success');
            }, 2000);
        }

        let editingQueueId = null;

        function editQueue(queueId) {
            const queue = queues.find(q => q.id === queueId);
            if (queue) {
                editingQueueId = queueId;
                document.getElementById('editDoctorName').value = queue.doctorName;
                document.getElementById('editQueueModal').classList.remove('hidden');
            }
        }

        function saveQueueEdit() {
            const newDoctorName = document.getElementById('editDoctorName').value.trim();
            
            if (!newDoctorName) {
                showToast('يرجى إدخال اسم الطبيب', 'error');
                return;
            }
            
            const queue = queues.find(q => q.id === editingQueueId);
            if (queue) {
                queue.doctorName = newDoctorName;
                populateQueues();
                
                // Update current queue display if it's the one being edited
                if (currentQueue && currentQueue.id === editingQueueId) {
                    currentQueue.doctorName = newDoctorName;
                    document.getElementById('doctorName').textContent = newDoctorName;
                }
                
                closeModal('editQueueModal');
                showToast('تم تحديث اسم الطبيب بنجاح', 'success');
            }
            
            editingQueueId = null;
        }

        function deleteQueue(queueId) {
            const queue = queues.find(q => q.id === queueId);
            if (queue && confirm(`هل أنت متأكد من حذف طابور ${queue.doctorName}؟`)) {
                queues = queues.filter(q => q.id !== queueId);
                populateQueues();
                
                // If current queue is deleted, go back to welcome screen
                if (currentQueue && currentQueue.id === queueId) {
                    hideAllPanels();
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    currentQueue = null;
                }
                
                showToast(`تم حذف طابور ${queue.doctorName} بنجاح`, 'success');
            }
        }

        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Quota management functions
        let currentQuotaModerator = null;

        function showQuotaManagementModal(moderatorId) {
            const moderator = managedUsers.moderator.find(m => m.id === moderatorId);
            if (!moderator) return;
            
            currentQuotaModerator = moderator;
            
            // Populate moderator info
            document.getElementById('quotaModeratorName').textContent = moderator.fullName;
            document.getElementById('quotaModeratorUsername').textContent = moderator.username;
            
            // Populate messages quota displays
            document.getElementById('totalMessagesQuotaDisplay').textContent = moderator.messagesQuota || 0;
            document.getElementById('consumedMessagesQuotaDisplay').textContent = moderator.consumedMessages || 0;
            document.getElementById('remainingMessagesQuotaDisplay').textContent = (moderator.messagesQuota || 0) - (moderator.consumedMessages || 0);
            document.getElementById('addMessagesQuota').value = '';
            
            // Populate queues quota displays
            document.getElementById('totalQueuesQuotaDisplay').textContent = moderator.queuesQuota || 0;
            document.getElementById('consumedQueuesQuotaDisplay').textContent = moderator.consumedQueues || 0;
            document.getElementById('remainingQueuesQuotaDisplay').textContent = (moderator.queuesQuota || 0) - (moderator.consumedQueues || 0);
            document.getElementById('addQueuesQuota').value = '';
            
            document.getElementById('quotaManagementModal').classList.remove('hidden');
        }

        function addQuota(quotaType) {
            if (!currentQuotaModerator) return;
            
            const addAmount = parseInt(document.getElementById(`add${quotaType === 'messages' ? 'Messages' : 'Queues'}Quota`).value) || 0;
            
            if (addAmount <= 0) {
                showToast('يرجى إدخال كمية صحيحة لإضافتها', 'error');
                return;
            }
            
            if (quotaType === 'messages') {
                currentQuotaModerator.messagesQuota += addAmount;
                document.getElementById('totalMessagesQuotaDisplay').textContent = currentQuotaModerator.messagesQuota;
                document.getElementById('remainingMessagesQuotaDisplay').textContent = currentQuotaModerator.messagesQuota - (currentQuotaModerator.consumedMessages || 0);
                document.getElementById('addMessagesQuota').value = '';
                showToast(`تم إضافة ${addAmount} رسالة إلى حصة ${currentQuotaModerator.fullName}`, 'success');
            } else {
                currentQuotaModerator.queuesQuota += addAmount;
                document.getElementById('totalQueuesQuotaDisplay').textContent = currentQuotaModerator.queuesQuota;
                document.getElementById('remainingQueuesQuotaDisplay').textContent = currentQuotaModerator.queuesQuota - (currentQuotaModerator.consumedQueues || 0);
                document.getElementById('addQueuesQuota').value = '';
                showToast(`تم إضافة ${addAmount} طابور إلى حصة ${currentQuotaModerator.fullName}`, 'success');
            }
            
            // Refresh the table
            showCombinedUserTable();
        }

        // Edit user functionality
        let editingUserId = null;
        let editingUserType = null;

        function editUser(userId, userType) {
            const user = managedUsers[userType].find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            editingUserType = userType;
            
            // Populate form
            document.getElementById('editUserFirstName').value = user.firstName || '';
            document.getElementById('editUserLastName').value = user.lastName || '';
            document.getElementById('editUserUsername').value = user.username;
            
            // Hide password display
            document.getElementById('newPasswordDisplay').classList.add('hidden');
            
            // Show/hide sections based on user type
            const moderatorSection = document.getElementById('editUserModeratorSection');
            
            if (userType === 'user') {
                moderatorSection.classList.remove('hidden');
                
                // Populate moderator dropdown
                const moderatorSelect = document.getElementById('editUserModerator');
                moderatorSelect.innerHTML = managedUsers.moderator.map(mod => 
                    `<option value="${mod.fullName}" ${user.moderator === mod.fullName ? 'selected' : ''}>${mod.fullName}</option>`
                ).join('');
            } else {
                moderatorSection.classList.add('hidden');
            }
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function saveUserEdit() {
            const user = managedUsers[editingUserType].find(u => u.id === editingUserId);
            if (!user) return;
            
            const firstName = document.getElementById('editUserFirstName').value.trim();
            const lastName = document.getElementById('editUserLastName').value.trim();
            const username = document.getElementById('editUserUsername').value.trim();
            
            if (!firstName || !lastName || !username) {
                showToast('يرجى إدخال جميع البيانات المطلوبة', 'error');
                return;
            }
            
            // Check if username is unique (excluding current user)
            const allUsers = [...managedUsers.secondary_admin, ...managedUsers.moderator, ...managedUsers.user];
            if (allUsers.some(u => u.username === username && u.id !== editingUserId)) {
                showToast('اسم المستخدم موجود بالفعل', 'error');
                return;
            }
            
            // Update user data
            user.firstName = firstName;
            user.lastName = lastName;
            user.fullName = `${firstName} ${lastName}`;
            user.username = username;
            
            if (editingUserType === 'user') {
                user.moderator = document.getElementById('editUserModerator').value;
            }
            
            // Refresh the appropriate table
            if (editingUserType === 'user') {
                showCombinedUserTable();
            } else {
                showUserManagementTable(editingUserType);
            }
            
            closeModal('editUserModal');
            showToast('تم تحديث بيانات المستخدم بنجاح', 'success');
        }

        function resetEditUserPassword() {
            const user = managedUsers[editingUserType].find(u => u.id === editingUserId);
            if (!user) return;
            
            if (confirm(`هل أنت متأكد من إعادة تعيين كلمة مرور ${user.fullName}؟`)) {
                const newPassword = generateRandomPassword();
                user.password = newPassword;
                
                // Show the new password in the modal
                document.getElementById('generatedPassword').textContent = newPassword;
                document.getElementById('newPasswordDisplay').classList.remove('hidden');
                
                showToast(`تم إعادة تعيين كلمة المرور بنجاح`, 'success');
            }
        }

        // Edit patient functionality
        let editingPatientId = null;
        let editingPatientType = null; // 'ongoing' or 'failed'
        let editingSessionId = null;

        function editOngoingPatient(position, sessionId, name, phone) {
            editingPatientId = position;
            editingPatientType = 'ongoing';
            editingSessionId = sessionId;
            
            document.getElementById('editPatientName').value = name;
            document.getElementById('editPatientPhone').value = phone;
            document.getElementById('editPatientModal').classList.remove('hidden');
        }

        function editFailedPatient(taskId, name, phone) {
            editingPatientId = taskId;
            editingPatientType = 'failed';
            
            document.getElementById('editPatientName').value = name;
            document.getElementById('editPatientPhone').value = phone;
            document.getElementById('editPatientModal').classList.remove('hidden');
        }

        function savePatientEdit() {
            const name = document.getElementById('editPatientName').value.trim();
            const phone = document.getElementById('editPatientPhone').value.trim();
            
            if (!name || !phone) {
                showToast('يرجى إدخال الاسم ورقم الهاتف', 'error');
                return;
            }
            
            if (editingPatientType === 'failed') {
                const task = failedTasks.find(t => t.id === editingPatientId);
                if (task) {
                    task.patientName = name;
                    task.phone = phone;
                    populateFailedTasks();
                }
            }
            // For ongoing patients, we would update the data structure in a real implementation
            
            closeModal('editPatientModal');
            showToast('تم تحديث بيانات المريض بنجاح', 'success');
        }

        // Selection count functions
        function updateOngoingSelectedCount(sessionId) {
            const selectedCheckboxes = document.querySelectorAll(`input[data-queue="${sessionId}"]:checked`);
            const count = selectedCheckboxes.length;
            const deleteButton = document.getElementById(`deleteOngoingText-${sessionId}`);
            if (deleteButton) {
                deleteButton.textContent = count > 0 ? `حذف ${count} محدد` : 'حذف المحدد';
            }
        }

        function updateFailedSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('.failed-task-checkbox:checked');
            const count = selectedCheckboxes.length;
            document.getElementById('deleteFailedText').textContent = count > 0 ? `حذف ${count} محدد` : 'حذف المحدد';
        }

        function deleteSelectedOngoingPatients(sessionId) {
            const selectedCheckboxes = document.querySelectorAll(`input[data-queue="${sessionId}"]:checked`);
            
            if (selectedCheckboxes.length === 0) {
                showToast('يرجى تحديد المرضى المراد حذفهم', 'error');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف ${selectedCheckboxes.length} مريض من الجلسة ${sessionId}؟`)) {
                showToast(`تم حذف ${selectedCheckboxes.length} مريض من الجلسة ${sessionId}`, 'success');
                populateOngoingTasks();
            }
        }

        function deleteSelectedFailedTasks() {
            const selectedCheckboxes = document.querySelectorAll('.failed-task-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast('يرجى تحديد المهام المراد حذفها', 'error');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف ${selectedCheckboxes.length} مهمة فاشلة؟`)) {
                const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                failedTasks = failedTasks.filter(t => !selectedIds.includes(t.id));
                populateFailedTasks();
                showToast(`تم حذف ${selectedCheckboxes.length} مهمة فاشلة`, 'success');
            }
        }

        function resetUserPassword(userId, userType) {
            const user = managedUsers[userType].find(u => u.id === userId);
            if (user && confirm(`هل أنت متأكد من إعادة تعيين كلمة مرور ${user.fullName}؟`)) {
                const newPassword = generateRandomPassword();
                
                // In a real system, this would be sent securely to the user
                showToast(`تم إعادة تعيين كلمة المرور. كلمة المرور الجديدة: ${newPassword}`, 'success');
                
                // Update user's password in the system (in real implementation, this would be hashed)
                user.password = newPassword;
            }
        }

        // Toggle functions for show/hide messages
        function toggleOngoingMessages(sessionId) {
            const messageCells = document.querySelectorAll(`.ongoing-message-${sessionId}`);
            const toggleButton = document.getElementById(`toggleOngoingText-${sessionId}`);
            
            messageCells.forEach(cell => {
                if (cell.style.display === 'none') {
                    cell.style.display = '';
                    toggleButton.textContent = 'إخفاء';
                } else {
                    cell.style.display = 'none';
                    toggleButton.textContent = 'إظهار';
                }
            });
        }

        function togglePreviewMessages() {
            const messageCells = document.querySelectorAll('.preview-message-cell');
            const messageColumn = document.querySelector('.preview-message-column');
            const toggleButton = document.getElementById('togglePreviewText');
            
            messageCells.forEach(cell => {
                if (cell.style.display === 'none') {
                    cell.style.display = '';
                    messageColumn.style.display = '';
                    toggleButton.textContent = 'إخفاء';
                } else {
                    cell.style.display = 'none';
                    messageColumn.style.display = 'none';
                    toggleButton.textContent = 'إظهار';
                }
            });
        }

        function showRetryPreview() {
            const selectedCheckboxes = document.querySelectorAll('.failed-task-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast('يرجى تحديد المهام المراد إعادة محاولتها', 'error');
                return;
            }
            
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            const selectedTasks = failedTasks.filter(t => selectedIds.includes(t.id));
            
            // Update retry preview modal
            document.getElementById('retryPreviewCount').textContent = `${selectedTasks.length} مهمة محددة`;
            
            // Populate retry preview table
            const tbody = document.getElementById('retryPreviewTable');
            tbody.innerHTML = '';
            
            selectedTasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900">${task.patientName}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${task.phone}</td>
                    <td class="px-6 py-4 text-sm text-red-600">${task.reason}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${Math.random() > 0.3 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${Math.random() > 0.3 ? 'متوقع النجاح' : 'قد يفشل مرة أخرى'}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('retryPreviewModal').classList.remove('hidden');
        }

        function confirmRetryTasks() {
            const selectedCheckboxes = document.querySelectorAll('.failed-task-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            
            let successCount = 0;
            const totalTasks = selectedIds.length;
            
            // Simulate retry process
            selectedIds.forEach(taskId => {
                if (Math.random() > 0.3) { // 70% success rate
                    successCount++;
                    failedTasks = failedTasks.filter(t => t.id !== taskId);
                } else {
                    // Update timestamp for failed retry
                    const task = failedTasks.find(t => t.id === taskId);
                    if (task) {
                        task.time = new Date().toLocaleString('ar-EG');
                    }
                }
            });
            
            populateFailedTasks();
            closeModal('retryPreviewModal');
            showToast(`تم إعادة إرسال ${successCount} من ${totalTasks} رسالة بنجاح`, 'success');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial focus
            document.getElementById('username').focus();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96c99f4a41a67947',t:'MTc1NDc2NzM0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
