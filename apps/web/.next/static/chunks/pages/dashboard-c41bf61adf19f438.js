(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[26],{1075:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard",function(){return a(2511)}])},3125:function(){},2511:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return Dashboard}});var s=a(5893),l=a(7294),n=a(3837);function QueueList(e){let{queues:t,selectedQueue:a,onSelect:l}=e;return(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-bold mb-2",children:"الطوابير"}),(0,s.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,s.jsxs)("button",{onClick:()=>l(e.id),className:"w-full text-right p-3 rounded border ".concat(a===e.id?"bg-blue-50 border-blue-300":""),children:[(0,s.jsx)("div",{className:"font-medium",children:e.doctorName}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:e.description})]},e.id))})]})}function PatientsTable(e){let{patients:t,onToggle:a}=e;return(0,s.jsx)("div",{className:"bg-white border rounded",children:(0,s.jsxs)("table",{className:"w-full",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"p-3 text-right",children:"تحديد"}),(0,s.jsx)("th",{className:"p-3 text-right",children:"الاسم"}),(0,s.jsx)("th",{className:"p-3 text-right",children:"هاتف"}),(0,s.jsx)("th",{className:"p-3 text-right",children:"ترتيب"})]})}),(0,s.jsx)("tbody",{children:t.map((e,t)=>{var l;return(0,s.jsxs)("tr",{className:"border-t ".concat(e._optimistic?"opacity-70":""),children:[(0,s.jsx)("td",{className:"p-3 text-right",children:(0,s.jsx)("input",{type:"checkbox",checked:!!e._selected,onChange:()=>a(t)})}),(0,s.jsx)("td",{className:"p-3 text-right",children:e.fullName}),(0,s.jsx)("td",{className:"p-3 text-right",children:e.phoneNumber}),(0,s.jsx)("td",{className:"p-3 text-right",children:e.position})]},null!==(l=e.id)&&void 0!==l?l:"tmp-".concat(t))})})]})})}var i=a(3125),d=a.n(i);function AddPatientsModal(e){let{open:t,onClose:a,onAdd:n}=e,[i,d]=(0,l.useState)([{fullName:"",phoneNumber:"",desiredPosition:""}]),[r,c]=(0,l.useState)(!1);function addSlot(){d(e=>[...e,{fullName:"",phoneNumber:"",desiredPosition:""}])}function updateSlot(e,t,a){d(s=>s.map((s,l)=>l===e?{...s,[t]:a}:s))}function removeSlot(e){d(t=>t.filter((t,a)=>a!==e))}async function submit(){let e=i.filter(e=>e.fullName.trim());if(!e.length)return alert("أدخل اسم واحد على الأقل");try{c(!0);let t=e.map(e=>({fullName:e.fullName,phoneNumber:e.phoneNumber,desiredPosition:e.desiredPosition?parseInt(e.desiredPosition,10):void 0}));await n(t)}finally{c(!1)}d([{fullName:"",phoneNumber:""}]),a()}return t?(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white rounded-xl p-6 w-full max-w-2xl max-h-96 overflow-y-auto",children:[(0,s.jsx)("h3",{className:"text-xl font-bold mb-4",children:"إضافة مرضى جدد"}),(0,s.jsx)("div",{className:"space-y-4",children:i.map((e,t)=>(0,s.jsxs)("div",{className:"patient-slot border border-gray-200 rounded-lg p-4 mb-2",children:[(0,s.jsxs)("div",{className:"flex items-center mb-3 justify-between",children:[(0,s.jsx)("div",{className:"text-sm text-gray-500",children:"مظهر رقمي: اترك فارغاً ليتم الإلحاق في النهاية"}),(0,s.jsx)("button",{onClick:()=>removeSlot(t),className:"text-red-500",children:"حذف"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"الاسم الكامل"}),(0,s.jsx)("input",{value:e.fullName,onChange:e=>updateSlot(t,"fullName",e.target.value),type:"text",className:"w-full px-3 py-2 border rounded-lg",placeholder:"أدخل الاسم الكامل"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"رقم الهاتف"}),(0,s.jsx)("input",{value:e.phoneNumber,onChange:e=>updateSlot(t,"phoneNumber",e.target.value),type:"text",className:"w-full px-3 py-2 border rounded-lg",placeholder:"رقم الهاتف"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"الموقع المرغوب (اختياري)"}),(0,s.jsx)("input",{value:e.desiredPosition,onChange:e=>updateSlot(t,"desiredPosition",e.target.value),type:"number",min:"1",className:"w-full px-3 py-2 border rounded-lg",placeholder:"مثال: 3"})]})]})]},t))}),(0,s.jsxs)("div",{className:"flex items-center space-x-3 mt-4 justify-between",children:[(0,s.jsx)("button",{onClick:addSlot,className:"bg-blue-600 text-white px-4 py-2 rounded",children:"إضافة صف"}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:a,className:"bg-gray-300 text-gray-700 px-4 py-2 rounded",children:"إلغاء"}),(0,s.jsx)("button",{onClick:submit,className:"bg-green-600 text-white px-4 py-2 rounded",children:r?"جارٍ الإضافة...":"إضافة المرضى"})]})]})]})}):null}let r=null;function showToast(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;r&&r(e,t)}function Toast(){let[e,t]=(0,l.useState)(null);return((0,l.useEffect)(()=>{r=(e,a)=>{t(e),setTimeout(()=>t(null),a)}},[]),e)?(0,s.jsx)("div",{className:"fixed bottom-6 left-6 z-50",children:(0,s.jsx)("div",{className:"bg-black text-white px-4 py-2 rounded shadow",children:e})}):null}function Dashboard(){let[e,t]=(0,l.useState)([]),[a,i]=(0,l.useState)(null),[r,c]=(0,l.useState)([]),[o,u]=(0,l.useState)([]),[m,h]=(0,l.useState)(null),[p,x]=(0,l.useState)(!1),[b,g]=(0,l.useState)(!1),[f,N]=(0,l.useState)(!1),[j,v]=(0,l.useState)(null);async function sendToSelected(){let e=r.filter(e=>e._selected).map(e=>e.id);if(!e.length)return alert("اختر مرضى أولا");try{var t;let a=await n.ZP.post("/api/messages/send",{templateId:m,patientIds:e,channel:"whatsapp"});alert("تم جدولة "+((null===(t=a.data)||void 0===t?void 0:t.queued)||0)+" رسالة")}catch(e){alert("فشل الإرسال")}}async function sendWithOverride(e){let t=r.filter(e=>e._selected).map(e=>e.id);if(!t.length)return alert("اختر مرضى أولا");try{var a;let s=await n.ZP.post("/api/messages/send",{templateId:m,patientIds:t,overrideContent:e,channel:"whatsapp"});alert("تم جدولة "+((null===(a=s.data)||void 0===a?void 0:a.queued)||0)+" رسالة")}catch(e){alert("فشل الإرسال")}}function togglePatient(e){c(t=>t.map((t,a)=>a===e?{...t,_selected:!t._selected}:t))}async function handleAddPatients(e){if(!a)return alert("اختر طابور أولاً");let t=Date.now(),s=[...r];s.sort((e,t)=>(e.position||0)-(t.position||0));let l=[];for(let a=0;a<e.length;a++){let n=e[a],i=n.desiredPosition?parseInt(n.desiredPosition,10):null,d=i&&i>0?i:s.length?Math.max(...s.map(e=>e.position||0))+1:1;s.forEach(e=>{(e.position||0)>=d&&(e.position=(e.position||0)+1)});let r={id:"tmp-".concat(t,"-").concat(a),fullName:n.fullName,phoneNumber:n.phoneNumber,position:d,_optimistic:!0};l.push(r),s.push(r)}s.sort((e,t)=>(e.position||0)-(t.position||0)),c(s.map(e=>({...e,_selected:!1})));try{for(let t of e)await n.ZP.post("/api/queues/".concat(a,"/patients"),{fullName:t.fullName,phoneNumber:t.phoneNumber,desiredPosition:t.desiredPosition?parseInt(t.desiredPosition,10):void 0});let t=await n.ZP.get("/api/queues/".concat(a,"/patients"));c((t.data.data||[]).map(e=>({...e,_selected:!1})))}catch(e){showToast("فشل إضافة بعض المرضى");try{let e=await n.ZP.get("/api/queues/".concat(a,"/patients"));c((e.data.data||[]).map(e=>({...e,_selected:!1})))}catch(e){c(e=>e.filter(e=>!e._optimistic))}}}(0,l.useEffect)(()=>{try{let e=JSON.parse(localStorage.getItem("currentUser"));v(e)}catch(e){}x(!0),n.ZP.get("/api/queues").then(e=>t(e.data.data||[])).catch(()=>{}).finally(()=>x(!1)),n.ZP.get("/api/templates").then(e=>{u(e.data.data||[]),e.data.data&&e.data.data.length&&h(e.data.data[0].id)}).catch(()=>{})},[]),(0,l.useEffect)(()=>{if(!a)return c([]);g(!0),n.ZP.get("/api/queues/".concat(a,"/patients")).then(e=>{let t=(e.data.data||[]).map(e=>({...e,_selected:!1}));t.sort((e,t)=>(e.position||0)-(t.position||0)),c(t)}).catch(()=>{}).finally(()=>g(!1))},[a]);let y=(null==j?void 0:j.role)&&["primary_admin","secondary_admin"].includes(j.role),[w,S]=(0,l.useState)("welcome"),[P,_]=(0,l.useState)("");return(0,s.jsxs)("div",{dir:"rtl",className:"p-8",children:[(0,s.jsx)(Toast,{}),(0,s.jsx)("h1",{className:"text-2xl mb-4",children:"لوحة التحكم"}),(0,s.jsxs)("div",{className:"grid grid-cols-4 gap-4 mb-6",children:[(0,s.jsxs)("div",{className:"col-span-1",children:[p?(0,s.jsx)("div",{children:"جارٍ تحميل الطوابير..."}):(0,s.jsx)(QueueList,{queues:e,selectedQueue:a,onSelect:e=>{i(e),S("queue")}}),(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsx)("button",{onClick:()=>{S("messages")},className:"w-full py-2 rounded mb-2 ".concat("messages"===w?"bg-blue-600 text-white":"bg-gray-100"),children:"الرسائل"}),y&&(0,s.jsx)("button",{onClick:()=>{S("management")},className:"w-full py-2 rounded ".concat("management"===w?"bg-gray-800 text-white":"bg-gray-100"),children:"الإدارة"})]})]}),(0,s.jsxs)("div",{className:"col-span-3",children:["welcome"===w&&(0,s.jsxs)("div",{className:"p-8 text-center",children:[(0,s.jsx)("h2",{className:"text-2xl font-bold mb-4",children:"مرحباً بك في نظام إدارة العيادات"}),(0,s.jsx)("p",{className:"text-gray-600",children:"اختر طابوراً أو افتح قسم الرسائل/الإدارة للبدء"})]}),"queue"===w&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,s.jsx)(d(),{templates:o,value:m,onChange:h}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)("button",{onClick:sendToSelected,className:"bg-purple-600 text-white px-4 py-2 rounded",children:"إرسال للمحدد"}),(0,s.jsx)("button",{onClick:()=>N(!0),className:"bg-green-600 text-white px-4 py-2 rounded",children:"إضافة مريض"})]})]}),b?(0,s.jsx)("div",{children:"جارٍ تحميل المرضى..."}):(0,s.jsx)(PatientsTable,{patients:r,onToggle:togglePatient})]}),"messages"===w&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-xl font-bold mb-4",children:"إرسال رسائل"}),(0,s.jsxs)("div",{className:"mb-4 flex items-start gap-6",children:[(0,s.jsx)("div",{className:"w-1/3",children:(0,s.jsx)(d(),{templates:o,value:m,onChange:h})}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("label",{className:"block text-sm mb-2",children:"معاينة / تعديل النص"}),(0,s.jsx)("textarea",{value:P,onChange:e=>_(e.target.value),rows:6,className:"w-full p-3 border rounded",placeholder:"ضع نص بديل هنا (اختياري)"})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("button",{onClick:()=>sendWithOverride(P||null),className:"bg-purple-600 text-white px-4 py-2 rounded",children:"إرسال للمحدد"}),(0,s.jsx)("button",{onClick:()=>{_("")},className:"bg-gray-200 px-4 py-2 rounded",children:"مسح"}),(0,s.jsx)("div",{className:"text-sm text-gray-600",children:"حدد مرضى من الطابور لجهة الإرسال"})]})]}),"management"===w&&y&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-xl font-bold mb-4",children:"إدارة النظام"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"bg-white p-4 border rounded",children:[(0,s.jsx)("h3",{className:"font-medium mb-3",children:"قوالب الرسائل"}),(0,s.jsx)(TemplatesManager,{})]}),(0,s.jsxs)("div",{className:"bg-white p-4 border rounded",children:[(0,s.jsx)("h3",{className:"font-medium mb-3",children:"المستخدمون"}),(0,s.jsx)(UsersManager,{})]})]})]})]})]}),(0,s.jsx)(AddPatientsModal,{open:f,onClose:()=>N(!1),onAdd:handleAddPatients})]})}function TemplatesManager(){let[e,t]=(0,l.useState)([]),[a,i]=(0,l.useState)(!1),[d,r]=(0,l.useState)(""),[c,o]=(0,l.useState)("");function load(){i(!0),n.ZP.get("/api/templates").then(e=>t(e.data.data||[])).catch(()=>{}).finally(()=>i(!1))}async function create(){if(!d||!c)return alert("املأ العنوان والمحتوى");try{await n.ZP.post("/api/templates",{title:d,content:c}),r(""),o(""),load()}catch(e){alert("فشل الإنشاء")}}return(0,l.useEffect)(()=>{load()},[]),(0,s.jsx)("div",{children:a?(0,s.jsx)("div",{children:"جارٍ التحميل..."}):(0,s.jsxs)("div",{children:[(0,s.jsx)("ul",{className:"space-y-2 mb-3",children:e.map(e=>(0,s.jsx)("li",{className:"border p-2 rounded",children:e.title||e.content.substring(0,60)},e.id))}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("input",{value:d,onChange:e=>r(e.target.value),placeholder:"عنوان",className:"w-full p-2 border rounded"}),(0,s.jsx)("textarea",{value:c,onChange:e=>o(e.target.value),placeholder:"محتوى",className:"w-full p-2 border rounded"}),(0,s.jsx)("div",{className:"flex gap-2",children:(0,s.jsx)("button",{onClick:create,className:"bg-blue-600 text-white px-4 py-2 rounded",children:"إنشاء"})})]})]})})}function UsersManager(){let[e,t]=(0,l.useState)([]),[a,i]=(0,l.useState)(!1),[d,r]=(0,l.useState)(""),[c,o]=(0,l.useState)(""),[u,m]=(0,l.useState)("user"),[h,p]=(0,l.useState)("");function load(){i(!0),n.ZP.get("/api/users").then(e=>t(e.data.data||[])).catch(()=>{}).finally(()=>i(!1))}async function create(){if(!d||!c)return showToast("املأ الحقول");try{await n.ZP.post("/api/users",{username:d,fullName:c,role:u,password:h||void 0}),r(""),o(""),m("user"),p(""),load(),showToast("تم إنشاء المستخدم")}catch(e){showToast("فشل الإنشاء")}}return(0,l.useEffect)(()=>load(),[]),(0,s.jsx)("div",{children:a?(0,s.jsx)("div",{children:"جارٍ التحميل..."}):(0,s.jsxs)("div",{children:[(0,s.jsx)("ul",{className:"space-y-2 mb-3",children:e.map(e=>(0,s.jsxs)("li",{className:"border p-2 rounded",children:[e.fullName," (",e.username,") - ",e.role]},e.id))}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("input",{value:d,onChange:e=>r(e.target.value),placeholder:"اسم المستخدم",className:"w-full p-2 border rounded"}),(0,s.jsx)("input",{value:c,onChange:e=>o(e.target.value),placeholder:"الاسم الكامل",className:"w-full p-2 border rounded"}),(0,s.jsxs)("select",{value:u,onChange:e=>m(e.target.value),className:"w-full p-2 border rounded",children:[(0,s.jsx)("option",{value:"user",children:"user"}),(0,s.jsx)("option",{value:"primary_admin",children:"primary_admin"}),(0,s.jsx)("option",{value:"secondary_admin",children:"secondary_admin"})]}),(0,s.jsx)("input",{value:h,onChange:e=>p(e.target.value),placeholder:"كلمة المرور (اختياري)",className:"w-full p-2 border rounded"}),(0,s.jsx)("div",{className:"flex gap-2",children:(0,s.jsx)("button",{onClick:create,className:"bg-blue-600 text-white px-4 py-2 rounded",children:"إنشاء مستخدم"})})]})]})})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=1075)}),_N_E=e.O()}]);